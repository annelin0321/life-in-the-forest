<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ©Ÿæ™ºçš„é–€å¾’ç”Ÿæ´» | æ£®æ—ç”Ÿæ…‹æ—¥èªŒ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&family=Noto+Serif+TC:wght@400;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    
    <!-- å¼•å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    
    <!-- å¼•å…¥ SQL.js (ç”¨æ–¼è®€å– SQLite è³‡æ–™åº«) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>

    <style>
        :root {
            /* è‡ªç„¶ç”Ÿæ…‹è‰²ç¥¨ */
            --bg-paper: #F1F3F2;
            --text-primary: #3E3B39;
            --text-secondary: #757575;
            --accent-green: #6B8E23;
            --accent-soft-green: #A3C1AD;
            --accent-blue: #8FA4AE;
            --accent-brown: #8D7B68;
            --accent-flower: #D8A69E;
            --accent-alert: #D85C42;
            --border-color: rgba(255, 255, 255, 0.6);
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(to bottom, #FAFAFA, #E8ECE9);
            color: var(--text-primary);
            line-height: 1.8;
            letter-spacing: 0.05em;
            position: relative;
            min-height: 100vh;
        }

        h1, h2, h3, .serif-font { font-family: 'Noto Serif TC', serif; }
        .eng-script { font-family: 'Playfair Display', serif; font-style: italic; }

        /* å°è¦½åˆ—ï¼šæ¥µåº¦é€šé€ */
        .nature-nav {
            border-bottom: 1px solid rgba(255,255,255,0.4);
            background-color: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 4px 30px rgba(0,0,0,0.01);
        }

        .nav-item {
            color: var(--text-secondary);
            font-size: 0.95rem;
            padding: 0.5rem 0.8rem;
            border-radius: 20px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            white-space: nowrap;
            cursor: pointer;
            border: 1px solid transparent;
        }
        
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.5);
            color: var(--accent-green);
            border-color: rgba(107, 142, 35, 0.3);
        }

        .nav-item.active {
            color: var(--accent-green);
            background-color: rgba(255, 255, 255, 0.6);
            font-weight: 600;
            border-color: rgba(107, 142, 35, 0.3);
            box-shadow: 0 2px 10px rgba(107, 142, 35, 0.05);
        }

        /* é€æ˜ä¿¡ç´™å¡ç‰‡ (æ ¸å¿ƒå®¹å™¨) */
        .stationery-card {
            background-color: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            padding: 3rem 2rem;
            box-shadow: 
                0 10px 40px -10px rgba(0, 0, 0, 0.03),
                inset 0 0 20px rgba(255, 255, 255, 0.5);
            position: relative;
            max-width: 800px;
            margin: 0 auto;
            border-radius: 16px;
        }
        .stationery-card::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 250px; height: 250px;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='50' cy='50' r='40' stroke='%236B8E23' stroke-width='1' opacity='0.05' stroke-dasharray='5 5'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            pointer-events: none;
        }

        /* ç¶“æ–‡é‡‘å¥å¡ç‰‡ */
        .verse-card-highlight {
            background-color: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(107, 142, 35, 0.3);
            padding: 2.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.02);
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
        }

        /* è–ç¶“ç€è¦½å™¨èˆ‡æœå°‹æ¡† */
        .bible-browser-container { margin-top: 2rem; }
        .bible-book-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px;
        }
        .bible-book-item {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.7);
            padding: 10px; text-align: center; border-radius: 8px;
            cursor: pointer; transition: all 0.3s; font-size: 0.9rem; color: var(--text-secondary);
        }
        .bible-book-item:hover {
            border-color: var(--accent-green); color: var(--accent-green);
            transform: translateY(-2px); background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .chapter-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px;
        }
        .chapter-item {
            background: rgba(163, 193, 173, 0.2);
            padding: 8px; text-align: center; border-radius: 6px;
            cursor: pointer; color: var(--accent-green); font-weight: bold; border: 1px solid transparent;
        }
        .chapter-item:hover { background: var(--accent-green); color: white; border-color: var(--accent-green); }

        .search-box { display: flex; gap: 8px; margin-bottom: 1.5rem; max-width: 500px; margin-left: auto; margin-right: auto; }
        .search-input {
            flex: 1; padding: 10px 20px;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 50px;
            outline: none; transition: all 0.3s;
            backdrop-filter: blur(4px);
        }
        .search-input:focus { border-color: var(--accent-green); background: rgba(255,255,255,0.9); box-shadow: 0 0 0 4px rgba(107, 142, 35, 0.1); }
        .search-btn {
            background: var(--accent-green); color: white; border: none; padding: 0 20px;
            border-radius: 50px; cursor: pointer; transition: opacity 0.3s;
            box-shadow: 0 4px 10px rgba(107, 142, 35, 0.3);
        }
        .search-btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* ä¸€èˆ¬æŒ‰éˆ• */
        .nature-btn {
            background-color: rgba(255, 255, 255, 0.6);
            border: 1px solid var(--accent-green); color: var(--accent-green);
            padding: 0.5rem 1.5rem; font-size: 0.9rem; letter-spacing: 0.1em;
            transition: all 0.3s ease; border-radius: 50px;
            display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer;
            backdrop-filter: blur(2px);
        }
        .nature-btn:hover { background-color: var(--accent-green); color: white; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(107, 142, 35, 0.2); }

        /* ç¶“æ–‡æŒ‰éˆ• */
        .scripture-btn { background-color: rgba(241, 248, 233, 0.6); border-color: #81C784; color: #33691e; }
        .scripture-btn:hover { background-color: #33691e; color: white; }

        /* è®€ç¶“é€²åº¦æŒ‰éˆ• (å°ˆå±¬æ¨£å¼) */
        .reading-plan-btn {
            background-color: white;
            border: 1px solid rgba(107, 142, 35, 0.2);
            color: #3E3B39;
            padding: 1rem;
            border-radius: 16px;
            text-align: left;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 4px;
            height: 100%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        }
        .reading-plan-btn:hover {
            border-color: var(--accent-green);
            background-color: rgba(107, 142, 35, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 142, 35, 0.1);
        }
        .reading-plan-btn .label {
            font-size: 0.7rem;
            color: var(--accent-green);
            font-weight: bold;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
        .reading-plan-btn .content {
            font-size: 1.1rem;
            font-family: 'Noto Serif TC', serif;
            font-weight: 600;
        }
        .reading-plan-btn i {
            position: absolute;
            right: 1rem;
            bottom: 1rem;
            opacity: 0.1;
            width: 24px;
            height: 24px;
            color: var(--accent-green);
        }

        /* é€šç”¨å¡ç‰‡ (é€æ˜åŒ–) */
        .clean-card {
            background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.6); padding: 2rem;
            transition: all 0.4s ease; height: 100%; display: flex; flex-direction: column; border-radius: 16px;
        }
        .clean-card:hover {
            border-color: var(--accent-blue); transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.7);
            box-shadow: 0 15px 30px rgba(143, 164, 174, 0.15);
        }

        .date-badge {
            font-family: 'Playfair Display', serif; color: var(--accent-brown); font-size: 0.85rem; letter-spacing: 0.1em;
            text-transform: uppercase; border: 1px solid var(--border-color); padding: 2px 14px; border-radius: 20px;
            display: inline-block; margin-bottom: 0.5rem; background: rgba(255, 255, 255, 0.6);
        }
        
        .must-read-badge {
            background-color: var(--accent-alert); color: white; font-size: 0.75rem; padding: 2px 12px;
            border-radius: 15px; display: inline-flex; align-items: center; gap: 4px;
            box-shadow: 0 2px 8px rgba(216, 92, 66, 0.3); animation: pulse-slow 3s infinite;
        }
        @keyframes pulse-slow { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.9; } }

        .divider-water {
            height: 10px; background-image: url("data:image/svg+xml,%3Csvg width='40' height='10' viewBox='0 0 40 10' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 5 Q 10 0 20 5 T 40 5' stroke='%23D6D2CC' fill='none' opacity='0.5' /%3E%3C/svg%3E");
            background-repeat: repeat-x; margin: 2rem 0; width: 100%;
        }

        .fade-in { animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none; }
        
        .framed-image {
            padding: 10px; background: rgba(255,255,255,0.9); border: 1px solid rgba(255,255,255,0.6); border-radius: 2px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); transform: rotate(1deg);
        }

        /* Chaplain Styles */
        .chaplain-tab-btn {
            padding: 0.75rem 1.5rem;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
            white-space: nowrap;
        }
        .chaplain-tab-btn.active {
            color: var(--accent-green);
            border-bottom-color: var(--accent-green);
        }
        .emotion-group {
            margin-bottom: 1.2rem;
        }
        .emotion-group-title {
            font-size: 0.85rem;
            color: #8D7B68;
            margin-bottom: 0.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .emotion-group-title::before {
            content: '';
            width: 4px;
            height: 14px;
            background-color: var(--accent-green);
            border-radius: 2px;
        }
        .emotion-chip {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid var(--accent-blue);
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .emotion-chip:hover, .emotion-chip.selected {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }
        /* Custom colors for emotion types */
        .emotion-chip.positive:hover, .emotion-chip.positive.selected { background: #81C784; border-color: #81C784; }
        .emotion-chip.neutral:hover, .emotion-chip.neutral.selected { background: #90A4AE; border-color: #90A4AE; }
        .emotion-chip.negative:hover, .emotion-chip.negative.selected { background: #E57373; border-color: #E57373; }

        .form-input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid rgba(141, 123, 104, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.5);
            margin-bottom: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }
        .form-input:focus {
            border-color: var(--accent-green);
            background: rgba(255, 255, 255, 0.8);
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #5d4037;
            font-size: 0.95rem;
        }
        
        .prayer-item-card {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            transition: all 0.2s;
            position: relative;
        }
        .prayer-item-card.answered {
            background: rgba(107, 142, 35, 0.1);
            border-color: var(--accent-green);
        }
        .prayer-status-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 4px;
        }
        
        /* Filter Button Styles */
        .filter-btn {
            font-size: 0.85rem;
            padding: 4px 12px;
            border-radius: 20px;
            border: 1px solid rgba(107, 142, 35, 0.2);
            background: rgba(255, 255, 255, 0.5);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-btn:hover { background: rgba(107, 142, 35, 0.1); }
        .filter-btn.active {
            background: var(--accent-green);
            color: white;
            border-color: var(--accent-green);
        }

        /* Flip Card Styles for Trivia */
        .flip-card {
            background-color: transparent;
            width: 100%;
            height: 400px;
            perspective: 1000px;
            cursor: pointer;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 16px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.6);
        }
        .flip-card-front {
            background: rgba(255, 255, 255, 0.8);
            color: #3E3B39;
        }
        .flip-card-back {
            background: #6B8E23;
            color: white;
            transform: rotateY(180deg);
        }

        /* Quiz Styles */
        .quiz-option {
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        /* ä¿®æ­£ï¼šåƒ…åœ¨æ”¯æ´ hover çš„è£ç½®ï¼ˆå¦‚é›»è…¦ï¼‰ä¸Šé¡¯ç¤ºæ‡¸åœæ•ˆæœ */
        @media (hover: hover) {
            .quiz-option:hover:not(:disabled) {
                background-color: rgba(107, 142, 35, 0.1);
                border-color: var(--accent-green);
            }
        }
        .quiz-option.correct {
            background-color: #d1fae5; /* green-100 */
            border-color: #10b981; /* green-500 */
            color: #065f46;
        }
        .quiz-option.wrong {
            background-color: #fee2e2; /* red-100 */
            border-color: #ef4444; /* red-500 */
            color: #991b1b;
        }
        .quiz-progress-bar {
            transition: width 1s linear;
        }

        /* Modal */
        #bible-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(60, 60, 58, 0.4); backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 100; display: none; justify-content: center; align-items: center;
        }
        #bible-modal.show { display: flex; }
        .modal-content {
            background: rgba(255, 252, 248, 0.98); width: 90%; max-width: 700px; max-height: 85vh;
            border-radius: 12px; padding: 2.5rem; overflow-y: auto; position: relative;
            box-shadow: 0 25px 60px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.8);
        }
        .close-modal { position: absolute; top: 1.5rem; right: 1.5rem; cursor: pointer; color: #8d6e63; transition: transform 0.2s; }
        .close-modal:hover { transform: rotate(90deg); }
        .verse-text { font-family: 'Noto Serif TC', serif; line-height: 2.2; margin-bottom: 0.8rem; color: #2c1810; font-size: 1.05rem; }
        .verse-num { color: var(--accent-green); font-size: 0.75em; margin-right: 0.8em; vertical-align: super; font-weight: bold; opacity: 0.8; }
        .search-result-item { padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; transition: background 0.2s; }
        .search-result-item:hover { background: rgba(107, 142, 35, 0.08); border-radius: 4px; }
    </style>
</head>
<body class="pb-20">

    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <!-- é å±± -->
        <svg class="absolute bottom-0 w-full h-64 text-[#C5C9C7] opacity-60" viewBox="0 0 1200 250" preserveAspectRatio="none" fill="currentColor">
            <path d="M0 250 C 300 100 500 280 800 120 C 1000 60 1100 200 1200 150 L 1200 250 L 0 250 Z" opacity="0.5"/>
            <path d="M0 250 C 150 180 300 240 450 200 C 600 160 750 220 900 190 C 1050 160 1200 220 1200 250 L 0 250 Z" opacity="0.8"/>
        </svg>

        <!-- å·¦ä¸‹çš„å…©æ£µæ¨¹ -->
        <svg class="absolute bottom-10 left-[3%] w-20 h-20 text-[#8D7B68] opacity-40" viewBox="0 0 100 100" fill="currentColor">
             <path d="M50 10 L 15 65 L 35 65 L 20 85 L 80 85 L 65 65 L 85 65 Z" />
             <rect x="45" y="85" width="10" height="15" />
        </svg>
        <svg class="absolute bottom-16 left-[9%] w-14 h-14 text-[#706C66] opacity-30" viewBox="0 0 100 100" fill="currentColor">
             <path d="M50 5 L 20 60 L 35 60 L 25 80 L 75 80 L 65 60 L 80 60 Z" />
             <rect x="46" y="80" width="8" height="20" />
        </svg>
        
        <!-- å³ä¸‹çš„æ¨¹æœ¨ -->
        <svg class="absolute bottom-28 right-[12%] w-16 h-16 text-[#706C66] opacity-30" viewBox="0 0 100 100" fill="currentColor">
             <path d="M50 10 L 20 60 L 35 60 L 25 80 L 75 80 L 65 60 L 80 60 Z" />
             <rect x="46" y="80" width="8" height="15" />
        </svg>

        <!-- å…‰æšˆ -->
        <div class="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-white/60 to-transparent pointer-events-none"></div>
    </div>

    <!-- å°è¦½åˆ— -->
    <nav class="nature-nav sticky top-0 z-50">
        <div class="container mx-auto px-6 max-w-5xl">
            <div class="flex flex-col md:flex-row justify-between items-center py-3">
                <div class="flex items-center gap-3 mb-4 md:mb-0 group cursor-pointer" onclick="switchTab('section-today')">
                    <div class="w-12 h-12 relative text-[#3E3B39] transition-transform duration-700 group-hover:rotate-6">
                        <svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full">
                            <circle cx="50" cy="50" r="45" stroke="#D6D2CC" />
                            <path d="M20 80 C 20 80 40 85 50 80 C 60 85 80 80 80 80" stroke="#3E3B39" />
                            <path d="M20 75 C 20 75 40 80 50 75 C 60 80 80 75 80 75" stroke="#3E3B39" opacity="0.5"/>
                            <path d="M25 75 L 40 45 L 55 75" stroke="#8FA4AE" />
                            <path d="M50 75 L 70 35 L 90 75" stroke="#8FA4AE" />
                            <path d="M35 75 L 35 55" stroke="#6B8E23" stroke-width="2"/>
                            <circle cx="35" cy="50" r="10" fill="#6B8E23" fill-opacity="0.1" stroke="#6B8E23"/>
                            <path d="M50 80 C 50 80 45 90 55 95" stroke="#8FA4AE" />
                            <path d="M60 25 Q 65 20 70 25" stroke="#8D7B68" />
                            <path d="M70 25 Q 75 20 80 25" stroke="#8D7B68" />
                        </svg>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-lg font-serif tracking-widest text-[#3E3B39] font-bold">æ©Ÿæ™ºçš„é–€å¾’ç”Ÿæ´»</span>
                        <span class="text-[0.65rem] text-[#706C66] tracking-[0.2em] uppercase">Life in the Forest</span>
                    </div>
                </div>
                
                <div class="flex flex-wrap justify-center gap-1">
                    <button onclick="switchTab('section-today')" id="nav-today" class="nav-item active">
                        <i data-lucide="book-open-check" class="w-4 h-4"></i> é€šè­˜ä¸­å¿ƒ
                    </button>
                    <button onclick="switchTab('section-verses')" id="nav-verses" class="nav-item">
                        <i data-lucide="library" class="w-4 h-4"></i> åœ–æ›¸é¤¨
                    </button>
                    <button onclick="switchTab('section-prayers')" id="nav-prayers" class="nav-item">
                        <i data-lucide="church" class="w-4 h-4"></i> æ ¡ç‰§å®¤
                    </button>
                    <button onclick="switchTab('section-school')" id="nav-school" class="nav-item">
                        <i data-lucide="graduation-cap" class="w-4 h-4"></i> å­¸éœ¸é¤Šæˆç­
                    </button>
                    <button onclick="switchTab('section-games')" id="nav-games" class="nav-item">
                        <i data-lucide="tent" class="w-4 h-4"></i> èª²å¤–æ´»å‹•
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="relative z-10 container mx-auto px-4 py-8 max-w-4xl">
        
        <div id="loading" class="flex flex-col items-center justify-center py-20 text-[#8D7B68]">
            <i data-lucide="loader-2" class="w-8 h-8 animate-spin mb-4 text-[#6B8E23]"></i>
            <p class="text-sm tracking-widest">æ­£åœ¨æ£®æ—è£¡å°‹æ‰¾æ™ºæ…§...</p>
        </div>

        <div id="main-content" class="min-h-[500px] opacity-0 transition-opacity duration-1000">

            <section id="section-today" class="page-section fade-in">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-serif text-[#3E3B39] mb-2">é€šè­˜ä¸­å¿ƒ</h1>
                    <p class="eng-script text-[#8D7B68]">Daily Manna</p>
                </div>
                <div class="stationery-card">
                    <div id="daily-content" class="flex flex-col items-center justify-center text-center"></div>
                </div>
            </section>

            <section id="section-verses" class="page-section hidden fade-in">
                <div id="blessing-container" class="mb-12">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-serif text-[#6B8E23]">ä»Šæ—¥é‡‘å¥</h2>
                        <p class="text-xs text-[#8D7B68] tracking-widest mt-1">BLESSING VERSE</p>
                    </div>
                    <div id="blessing-card-area"></div>
                </div>
                <div class="w-full h-px bg-[rgba(214,210,204,0.6)] my-10"></div>
                <div id="bible-browser" class="bible-browser-container">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-serif text-[#3E3B39]">è–ç¶“è—æ›¸é–£</h2>
                        <p class="text-xs text-[#8D7B68] tracking-widest mt-1">HOLY BIBLE LIBRARY</p>
                    </div>
                    <div class="search-box">
                        <input type="text" id="bible-search-input" placeholder="è¼¸å…¥é—œéµå­— (å¦‚: æ„›, å…‰)..." class="search-input" onkeypress="handleSearch(event)">
                        <button onclick="performSearch()" class="search-btn"><i data-lucide="search" class="w-4 h-4"></i></button>
                    </div>
                    <div id="bible-display-area" class="bg-[rgba(255,255,255,0.4)] backdrop-blur-md p-6 rounded-lg border border-[rgba(255,255,255,0.6)] min-h-[300px]">
                        <div class="text-center text-gray-400 py-10">
                            <i data-lucide="library" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                            <p>è¼‰å…¥è–ç¶“ç›®éŒ„ä¸­...</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="section-prayers" class="page-section hidden fade-in">
                <!-- Chaplain Content rendered by JS -->
                <div id="chaplain-content"></div>
            </section>

            <section id="section-school" class="page-section hidden fade-in">
                <div id="school-menu">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-serif text-[#3E3B39]">å­¸éœ¸é¤Šæˆç­</h2>
                        <p class="eng-script text-[#8D7B68]">Bible Study & Trivia</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Menu Items generated by JS -->
                    </div>
                </div>
                <div id="school-quiz-area" class="hidden">
                    <!-- Quiz Interface generated by JS -->
                </div>
            </section>

            <section id="section-games" class="page-section hidden fade-in">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-serif text-[#3E3B39]">èª²å¤–æ´»å‹•</h2>
                    <p class="eng-script text-[#8D7B68]">Fellowship</p>
                </div>
                <div id="grid-games" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
            </section>

        </div>

        <footer class="mt-24 border-t border-[rgba(255,255,255,0.5)] pt-8 pb-12 text-center text-xs text-[#8D7B68] tracking-widest">
            <p>Â© æ©Ÿæ™ºçš„é–€å¾’ç”Ÿæ´» | WITTY DISCIPLE LIFE</p>
            <div class="mt-4 flex justify-center gap-4 text-xs text-[#8D7B68]">
                <button onclick="exportData()" class="hover:text-[#6B8E23] flex items-center gap-1 transition-colors cursor-pointer">
                    <i data-lucide="download" class="w-3 h-3"></i> å‚™ä»½è³‡æ–™
                </button>
                <div class="w-px h-3 bg-[#8D7B68] opacity-30 self-center"></div>
                <button onclick="document.getElementById('import-file').click()" class="hover:text-[#6B8E23] flex items-center gap-1 transition-colors cursor-pointer">
                    <i data-lucide="upload" class="w-3 h-3"></i> åŒ¯å…¥è³‡æ–™
                </button>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
            </div>
        </footer>
    </div>

    <div id="bible-modal" onclick="closeBibleModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <!-- æ–°çš„é—œé–‰æŒ‰éˆ•ï¼Œç½®æ–¼å³ä¸Šè§’ -->
            <button onclick="closeBibleModal()" class="absolute top-6 right-6 flex items-center justify-center gap-1 text-xs text-[#6B8E23] hover:text-[#556B2F] transition-colors bg-[#F1F3F2] px-4 py-1.5 rounded-full shadow-sm z-50">
                <i data-lucide="x" class="w-3 h-3"></i>
                <span>é—œé–‰</span>
            </button>
            <div class="text-center mb-6">
                <h3 id="modal-title" class="text-2xl font-serif text-[#3E3B39] font-bold">ç¶“æ–‡é–±è®€</h3>
                <div class="w-12 h-px bg-[#8D7B68] mx-auto mt-2"></div>
            </div>
            <div id="modal-body" class="text-lg text-[#4e342e]"></div>
        </div>
    </div>

    <script>
        try { if (window.lucide) window.lucide.createIcons(); } catch (e) {}

        const DEVOTION_DATA_URL = 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/devotionals.json';
        const BLESSING_VERSES_URL = 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/blessing-verses.json';
        const BIBLE_DB_URL = 'https://raw.githubusercontent.com/annelin0321/bible-zh/main/bible_complete.db';
        const PRAYERS_DATA_URL = 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/prayers.json';

        // Quiz Configurations
        const QUIZ_CONFIG = [
            {
                id: 'exam',
                title: 'è–ç¶“å¤§æœƒè€ƒ',
                subtitle: 'é™æ™‚æŒ‘æˆ° (3åˆ†é˜)',
                icon: 'timer',
                type: 'exam', // Timed, batch score
                url: 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/bible-quiz.json',
                desc: 'æ¸¬é©—ä½ çš„è–ç¶“ç¶œåˆèƒ½åŠ›ï¼Œæ™‚é–“åˆ°æ‰ç®—åˆ†å–”ï¼'
            },
            {
                id: 'messiah',
                title: 'é‡è¦‹å½Œè³½äº',
                subtitle: 'è€¶ç©Œç”Ÿå¹³',
                icon: 'cross',
                type: 'practice', // Instant feedback
                url: 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/life-of-jesus.json',
                desc: 'æ·±å…¥äº†è§£è€¶ç©Œçš„ç”Ÿå¹³èˆ‡æ•™å°ã€‚'
            },
            {
                id: 'characters',
                title: 'è–ç¶“äººç‰©',
                subtitle: 'äººç‰©èªŒ',
                icon: 'users',
                type: 'practice',
                url: 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/bible-characters.json',
                desc: 'çŒœçŒœä»–æ˜¯èª°ï¼Ÿèªè­˜è–ç¶“ä¸­çš„é—œéµäººç‰©ã€‚'
            },
            {
                id: 'geography',
                title: 'è–ç¶“åœ°ç†',
                subtitle: 'åœ°åœ–å°è¦½',
                icon: 'map',
                type: 'practice',
                url: 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/bible-geography.json',
                desc: 'è·Ÿè‘—è–ç¶“å»æ—…è¡Œï¼Œæ¢ç´¢æ‡‰è¨±ä¹‹åœ°ã€‚'
            },
            {
                id: 'trivia',
                title: 'è–ç¶“å†·çŸ¥è­˜',
                subtitle: 'ç¿»ç‰Œå•ç­”',
                icon: 'lightbulb',
                type: 'trivia', // Flip card
                url: 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/bible-trivia.json',
                desc: 'åŸä¾†è–ç¶“é‚„æœ‰é€™äº›å°çŸ¥è­˜ï¼Ÿç¿»ç‰Œè¦‹çœŸç« ï¼'
            }
        ];

        let db = null;
        let isDbLoading = false;
        let bibleBooksCache = [];
        let devotionalsData = [];
        let prayersData = []; // Store fetched prayers
        let dbCols = {};
        
        // Quiz State
        let currentQuizData = [];
        let currentQuizConfig = null;
        let currentQuestionIndex = 0;
        let quizScore = 0;
        let quizTimer = null;
        let quizTimeLeft = 0;
        let userExamAnswers = []; // For exam mode results

        let editingPrayerId = null; // Track which prayer is being edited
        let currentPrayerFilter = 'all'; // 'all', 'praying', 'answered'

        // One Year Bible Plan Data (Generated for common reading plan logic)
        const bibleReadingPlan = {};
        
        // Expanded Emotion Vocabulary based on Psychology/Psychiatry models
        const emotionCategories = {
            "æ„‰æ‚…èˆ‡é€£çµ (Joy & Connection)": [
                "å¹¸ç¦", "æ»¿è¶³", "èˆˆå¥®", "æ„Ÿæ¿€", "è‡ªè±ª", "æ¨‚è§€", "ç‹‚å–œ", "è¢«æ„›", 
                "æ•¬ç•", "ç†±æƒ…", "å……æ»¿å¸Œæœ›", "è¦ªå¯†", "ä¿¡ä»»", "å®‰è©³", "è¢«æ¥ç´"
            ],
            "å¹³éœèˆ‡æ•ˆèƒ½ (Peace & Efficacy)": [
                "å¹³éœ", "æ”¾é¬†", "å°ˆæ³¨", "æ²‰æ€", "å‹ä»»æ„Ÿ", "ç©©å®š", "è‡ªåœ¨", "é‡‹æ‡·", 
                "æ­£å¿µ", "æ¸…é†’", "è¸å¯¦", "å¾å®¹"
            ],
            "æ†¤æ€’èˆ‡æ•µæ„ (Anger & Hostility)": [
                "æ†¤æ€’", "ç…©èº", "æŒ«æŠ˜", "æ•µæ„", "æ†¤æ…¨", "æ¿€å‹•", "æš´æ€’", "è¢«å†’çŠ¯", 
                "é˜²è¡›", "è¼•è”‘", "æ€¨æ¨", "ä¸å¹³", "å­ç…©"
            ],
            "æ‚²å‚·èˆ‡å¤±è½ (Sadness & Loss)": [
                "æ‚²å‚·", "æ†‚é¬±", "å¤±æœ›", "çµ•æœ›", "å“€æ…Ÿ", "å­¤ç¨", "æ·’æ¶¼", "å¿ƒç¢", 
                "ç„¡åŠ©", "å—å‚·", "éºæ†¾", "æ¶ˆæ²‰", "ç©ºè™›"
            ],
            "ææ‡¼èˆ‡ç„¦æ…® (Fear & Anxiety)": [
                "ç„¦æ…®", "æ“”æ†‚", "ææ…Œ", "ç·Šå¼µ", "ææ‡¼", "ä¸å®‰", "å£“è¿«æ„Ÿ", "ç–‘æ…®", 
                "è„†å¼±", "é©šåš‡", "æˆ’æ…", "ç¥ç¶“è³ª", "çª’æ¯æ„Ÿ"
            ],
            "è‡ªè¦ºæƒ…ç·’ (Self-Conscious)": [
                "ç¾æ„§", "å…§ç–š", "å°·å°¬", "æ‡Šæ‚”", "ç¾è¾±", "è‡ªè²¬", "å«‰å¦’", "ç¾¨æ…•", 
                "è‡ªå‘", "ç„¡åœ°è‡ªå®¹"
            ],
            "èªçŸ¥èˆ‡ç‹€æ…‹ (Cognitive & State)": [
                "é©šè¨", "éœ‡é©š", "å›°æƒ‘", "çŸ›ç›¾", "èŒ«ç„¶", "éº»æœ¨", "ç–é›¢", "çŒ¶è±«", 
                "ç–²æ†Š", "æ··äº‚", "æŠ½é›¢"
            ]
        };

        async function init() {
            try {
                generateReadingPlan();
                checkFutureLetters(); // Check letters on load
                
                await Promise.all([
                    fetchData(),
                    fetchBlessingVerses(),
                    fetchPrayers()
                ]);
                
                initBibleDB().then(() => {
                    const area = document.getElementById('bible-display-area');
                    if(area && area.innerText.includes('è¼‰å…¥è–ç¶“ç›®éŒ„ä¸­')) {
                        renderBibleBrowserHome();
                    }
                });
            } catch (err) {
                console.error("Initialization Error:", err);
            }
        }

        async function fetchPrayers() {
            try {
                const res = await fetch(PRAYERS_DATA_URL);
                if (res.ok) {
                    prayersData = await res.json();
                } else {
                    console.warn("Using default prayers due to fetch error");
                }
            } catch(e) { console.error("Failed to fetch prayers", e); }
        }

        function generateReadingPlan() {
            // Restore full January data so the reading plan appears every day
            const janData = [
                {d:1, ot:"å‰µä¸–è¨˜ 1-2", nt:"é¦¬å¤ªç¦éŸ³ 1", ps:"è©©ç¯‡ 1", pr:"ç®´è¨€ 1:1-6"},
                {d:2, ot:"å‰µä¸–è¨˜ 3-5", nt:"é¦¬å¤ªç¦éŸ³ 2", ps:"è©©ç¯‡ 2", pr:"ç®´è¨€ 1:7-9"},
                {d:3, ot:"å‰µä¸–è¨˜ 6-8", nt:"é¦¬å¤ªç¦éŸ³ 3", ps:"è©©ç¯‡ 3", pr:"ç®´è¨€ 1:10-19"},
                {d:4, ot:"å‰µä¸–è¨˜ 9-11", nt:"é¦¬å¤ªç¦éŸ³ 4", ps:"è©©ç¯‡ 4", pr:"ç®´è¨€ 1:20-33"},
                {d:5, ot:"å‰µä¸–è¨˜ 12-14", nt:"é¦¬å¤ªç¦éŸ³ 5:1-26", ps:"è©©ç¯‡ 5", pr:"ç®´è¨€ 2:1-5"},
                {d:6, ot:"å‰µä¸–è¨˜ 15-17", nt:"é¦¬å¤ªç¦éŸ³ 5:27-48", ps:"è©©ç¯‡ 6", pr:"ç®´è¨€ 2:6-15"},
                {d:7, ot:"å‰µä¸–è¨˜ 18-19", nt:"é¦¬å¤ªç¦éŸ³ 6", ps:"è©©ç¯‡ 7", pr:"ç®´è¨€ 2:16-22"},
                {d:8, ot:"å‰µä¸–è¨˜ 20-22", nt:"é¦¬å¤ªç¦éŸ³ 7", ps:"è©©ç¯‡ 8", pr:"ç®´è¨€ 3:1-6"},
                {d:9, ot:"å‰µä¸–è¨˜ 23-24", nt:"é¦¬å¤ªç¦éŸ³ 8:1-17", ps:"è©©ç¯‡ 9:1-12", pr:"ç®´è¨€ 3:7-10"},
                {d:10, ot:"å‰µä¸–è¨˜ 25-26", nt:"é¦¬å¤ªç¦éŸ³ 8:18-34", ps:"è©©ç¯‡ 9:13-20", pr:"ç®´è¨€ 3:11-12"},
                {d:11, ot:"å‰µä¸–è¨˜ 27-28", nt:"é¦¬å¤ªç¦éŸ³ 9:1-17", ps:"è©©ç¯‡ 10:1-11", pr:"ç®´è¨€ 3:13-18"},
                {d:12, ot:"å‰µä¸–è¨˜ 29-30", nt:"é¦¬å¤ªç¦éŸ³ 9:18-38", ps:"è©©ç¯‡ 10:12-18", pr:"ç®´è¨€ 3:19-26"},
                {d:13, ot:"å‰µä¸–è¨˜ 31", nt:"é¦¬å¤ªç¦éŸ³ 10:1-23", ps:"è©©ç¯‡ 11", pr:"ç®´è¨€ 3:27-32"},
                {d:14, ot:"å‰µä¸–è¨˜ 32-33", nt:"é¦¬å¤ªç¦éŸ³ 10:24-42", ps:"è©©ç¯‡ 12", pr:"ç®´è¨€ 3:33-35"},
                {d:15, ot:"å‰µä¸–è¨˜ 34-35", nt:"é¦¬å¤ªç¦éŸ³ 11:1-19", ps:"è©©ç¯‡ 13", pr:"ç®´è¨€ 4:1-9"},
                {d:16, ot:"å‰µä¸–è¨˜ 36-37", nt:"é¦¬å¤ªç¦éŸ³ 11:20-30", ps:"è©©ç¯‡ 14", pr:"ç®´è¨€ 4:10-19"},
                {d:17, ot:"å‰µä¸–è¨˜ 38-40", nt:"é¦¬å¤ªç¦éŸ³ 12:1-21", ps:"è©©ç¯‡ 15", pr:"ç®´è¨€ 4:20-27"},
                {d:18, ot:"å‰µä¸–è¨˜ 41", nt:"é¦¬å¤ªç¦éŸ³ 12:22-50", ps:"è©©ç¯‡ 16", pr:"ç®´è¨€ 5:1-6"},
                {d:19, ot:"å‰µä¸–è¨˜ 42-43", nt:"é¦¬å¤ªç¦éŸ³ 13:1-23", ps:"è©©ç¯‡ 17", pr:"ç®´è¨€ 5:7-14"},
                {d:20, ot:"å‰µä¸–è¨˜ 44-45", nt:"é¦¬å¤ªç¦éŸ³ 13:24-43", ps:"è©©ç¯‡ 18:1-15", pr:"ç®´è¨€ 5:15-23"},
                {d:21, ot:"å‰µä¸–è¨˜ 46-48", nt:"é¦¬å¤ªç¦éŸ³ 13:44-58", ps:"è©©ç¯‡ 18:16-36", pr:"ç®´è¨€ 6:1-5"},
                {d:22, ot:"å‰µä¸–è¨˜ 49-50", nt:"é¦¬å¤ªç¦éŸ³ 14:1-21", ps:"è©©ç¯‡ 18:37-50", pr:"ç®´è¨€ 6:6-11"},
                {d:23, ot:"å‡ºåŸƒåŠè¨˜ 1-3", nt:"é¦¬å¤ªç¦éŸ³ 14:22-36", ps:"è©©ç¯‡ 19", pr:"ç®´è¨€ 6:12-15"},
                {d:24, ot:"å‡ºåŸƒåŠè¨˜ 4-6", nt:"é¦¬å¤ªç¦éŸ³ 15:1-20", ps:"è©©ç¯‡ 20", pr:"ç®´è¨€ 6:16-19"},
                {d:25, ot:"å‡ºåŸƒåŠè¨˜ 7-8", nt:"é¦¬å¤ªç¦éŸ³ 15:21-39", ps:"è©©ç¯‡ 21", pr:"ç®´è¨€ 6:20-26"},
                {d:26, ot:"å‡ºåŸƒåŠè¨˜ 9-10", nt:"é¦¬å¤ªç¦éŸ³ 16", ps:"è©©ç¯‡ 22:1-11", pr:"ç®´è¨€ 6:27-35"},
                {d:27, ot:"å‡ºåŸƒåŠè¨˜ 11-12", nt:"é¦¬å¤ªç¦éŸ³ 17", ps:"è©©ç¯‡ 22:12-31", pr:"ç®´è¨€ 7:1-5"},
                {d:28, ot:"å‡ºåŸƒåŠè¨˜ 13-15", nt:"é¦¬å¤ªç¦éŸ³ 18:1-20", ps:"è©©ç¯‡ 23", pr:"ç®´è¨€ 7:6-23"},
                {d:29, ot:"å‡ºåŸƒåŠè¨˜ 16-18", nt:"é¦¬å¤ªç¦éŸ³ 18:21-35", ps:"è©©ç¯‡ 24", pr:"ç®´è¨€ 7:24-27"},
                {d:30, ot:"å‡ºåŸƒåŠè¨˜ 19-21", nt:"é¦¬å¤ªç¦éŸ³ 19:1-15", ps:"è©©ç¯‡ 25:1-11", pr:"ç®´è¨€ 8:1-11"},
                {d:31, ot:"å‡ºåŸƒåŠè¨˜ 22-24", nt:"é¦¬å¤ªç¦éŸ³ 19:16-30", ps:"è©©ç¯‡ 25:12-22", pr:"ç®´è¨€ 8:12-13"}
            ];
            janData.forEach(day => { bibleReadingPlan[`1-${day.d}`] = day; });
        }

        /* --- Chaplain Office Logic --- */
        function renderChaplainOffice() {
            const container = document.getElementById('chaplain-content');
            
            // Random Prayer with Backup
            let randomPrayer = null;
            if (prayersData.length > 0) {
                randomPrayer = prayersData[Math.floor(Math.random() * prayersData.length)];
            } else {
                // Default fallback prayers to ensure content is always shown
                const defaults = [
                    { title: "ä¸»ç¦±æ–‡", ref: "é¦¬å¤ªç¦éŸ³ 6:9-13", fullText: "æˆ‘å€‘åœ¨å¤©ä¸Šçš„çˆ¶ï¼š\né¡˜äººéƒ½å°Šä½ çš„åç‚ºè–ã€‚\né¡˜ä½ çš„åœ‹é™è‡¨ï¼›\né¡˜ä½ çš„æ—¨æ„è¡Œåœ¨åœ°ä¸Šï¼Œ\nå¦‚åŒè¡Œåœ¨å¤©ä¸Šã€‚\næˆ‘å€‘æ—¥ç”¨çš„é£²é£Ÿï¼Œä»Šæ—¥è³œçµ¦æˆ‘å€‘ã€‚\nå…æˆ‘å€‘çš„å‚µï¼Œå¦‚åŒæˆ‘å€‘å…äº†äººçš„å‚µã€‚\nä¸å«æˆ‘å€‘é‡è¦‹è©¦æ¢ï¼›\næ•‘æˆ‘å€‘è„«é›¢å…‡æƒ¡ã€‚\nå› ç‚ºåœ‹åº¦ã€æ¬ŠæŸ„ã€æ¦®è€€ï¼Œå…¨æ˜¯ä½ çš„ï¼Œ\nç›´åˆ°æ°¸é ã€‚é˜¿å€‘ã€‚" },
                    { title: "å°¼å¸ƒçˆ¾çš„å¯§éœç¦±æ–‡", ref: "Reinhold Niebuhr", fullText: "ç¥å•Šï¼Œ\nè«‹è³œçµ¦æˆ‘å¯§éœï¼Œ\nå»æ¥å—æˆ‘ç„¡æ³•æ”¹è®Šçš„äº‹ï¼›\nè³œçµ¦æˆ‘å‹‡æ°£ï¼Œ\nå»æ”¹è®Šæˆ‘èƒ½æ”¹è®Šçš„äº‹ï¼›\nä¸¦è³œçµ¦æˆ‘æ™ºæ…§ï¼Œ\nå»åˆ†è¾¨é€™å…©è€…çš„å·®åˆ¥ã€‚" }
                ];
                randomPrayer = defaults[Math.floor(Math.random() * defaults.length)];
            }
            
            // Try to handle case-insensitive keys if JSON structure varies
            const title = randomPrayer.title || randomPrayer.Title || "ä»Šæ—¥ç¦±å‘Š";
            const ref = randomPrayer.ref || randomPrayer.Ref || randomPrayer.reference || "";
            const text = randomPrayer.fullText || randomPrayer.fulltext || randomPrayer.Fulltext || randomPrayer.content || randomPrayer.Content || "å…§å®¹è®€å–ä¸­...";

            // Build Emotion Tags HTML
            let emotionHtml = '';
            for (const [category, emotions] of Object.entries(emotionCategories)) {
                let typeClass = 'neutral';
                // Update styling logic for new formal categories
                if(category.includes('æ„‰æ‚…') || category.includes('å¹³éœ')) typeClass = 'positive';
                else if(category.includes('æ†¤æ€’') || category.includes('æ‚²å‚·') || category.includes('ææ‡¼') || category.includes('è‡ªè¦º')) typeClass = 'negative';
                
                emotionHtml += `
                    <div class="emotion-group">
                        <div class="emotion-group-title">${category}</div>
                        <div class="flex flex-wrap gap-1">
                            ${emotions.map(e => `<span class="emotion-chip ${typeClass}" onclick="toggleEmotion(this)">${e}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            // Get Today's Date and Reading Plan for Devotion
            const dObj = new Date();
            const m = dObj.getMonth() + 1;
            const d = dObj.getDate();
            const plan = bibleReadingPlan[`${m}-${d}`];
            const planText = plan ? `${plan.ot} | ${plan.nt} | ${plan.ps} | ${plan.pr}` : 'è‡ªè¡Œé–±è®€';

            // Tabs UI
            const html = `
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-serif text-[#3E3B39]">æ ¡ç‰§å®¤</h2>
                    <p class="eng-script text-[#8D7B68]">Chaplain's Office</p>
                </div>

                <!-- Prayer Card -->
                <div class="stationery-card mb-12">
                    <div id="daily-prayer-display">
                        <div class="flex flex-col items-center text-center mb-6">
                            <h3 class="text-xl font-bold text-[#6B8E23] mb-2">${title}</h3>
                            <span class="text-xs text-gray-400 border border-gray-300 rounded px-2 py-0.5">${ref}</span>
                        </div>
                        <p class="text-[#585858] leading-relaxed whitespace-pre-wrap mb-6 font-light text-center">${text}</p>
                        <div class="text-center">
                            <button onclick="refreshPrayer()" class="text-xs text-[#8D7B68] hover:text-[#6B8E23] flex items-center justify-center gap-1 mx-auto transition-colors">
                                <i data-lucide="refresh-cw" class="w-3 h-3"></i> æ›ä¸€å‰‡ç¦±å‘Š
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tools Navigation -->
                <div class="flex justify-center border-b border-gray-200 mb-8">
                    <div class="flex flex-wrap justify-center gap-2 px-2 pb-1">
                        <div class="chaplain-tab-btn active" onclick="switchChaplainTab('tab-devotion', this)">éˆä¿®ç­†è¨˜</div>
                        <div class="chaplain-tab-btn" onclick="switchChaplainTab('tab-prayer-list', this)">ç¦±å‘Šæ—¥è¨˜</div>
                        <div class="chaplain-tab-btn" onclick="switchChaplainTab('tab-gratitude', this)">æ„Ÿæ©æ—¥è¨˜</div>
                        <div class="chaplain-tab-btn" onclick="switchChaplainTab('tab-emotion', this)">æƒ…ç·’æ—¥è¨˜</div>
                        <div class="chaplain-tab-btn" onclick="switchChaplainTab('tab-letter', this)">æ™‚ç©ºè† å›Š</div>
                    </div>
                </div>

                <!-- Tools Content -->
                <div id="tab-devotion" class="chaplain-tab-content fade-in">
                    <div class="bg-white/60 p-6 rounded-xl border border-gray-100 shadow-sm max-w-2xl mx-auto">
                        <p class="text-center text-sm text-[#8D7B68] mb-6">è†è½ç¥è²éŸ³ï¼Œå›æ‡‰ç¥‚çš„æ„›ã€‚</p>
                        
                        <label class="form-label">ä»Šæ—¥ç¶“æ–‡ (Today's Scripture)</label>
                        <input type="text" class="form-input bg-gray-100/50" value="${planText}" readonly>

                        <label class="form-label">ç¶“æ–‡å¤§æ„ (Summary)</label>
                        <textarea id="dev-summary" class="form-input" rows="3" placeholder="è©¦è‘—ç”¨è‡ªå·±çš„è©±å¯«ä¸‹é€™æ®µç¶“æ–‡åœ¨èªªä»€éº¼..."></textarea>

                        <label class="form-label">æœ€æœ‰æ„Ÿå‹•çš„ä¸€å¥ç¶“æ–‡ (Rhema)</label>
                        <input id="dev-verse" type="text" class="form-input" placeholder="å“ªä¸€å¥è©±æŠ“ä½äº†ä½ çš„å¿ƒï¼Ÿ">

                        <label class="form-label">ç”Ÿæ´»æ‡‰ç”¨ (Application)</label>
                        <textarea id="dev-app" class="form-input" rows="2" placeholder="é€™æ®µç¶“æ–‡å¦‚ä½•æ‡‰ç”¨åœ¨æˆ‘ä»Šå¤©çš„ç”Ÿæ´»ä¸­ï¼Ÿ"></textarea>

                        <label class="form-label">å¤©çˆ¶çš„å¿ƒæ„ (Father's Heart)</label>
                        <textarea id="dev-heart" class="form-input" rows="2" placeholder="é€éé€™æ®µç¶“æ–‡ï¼Œå¤©çˆ¶æƒ³å°ä½ èªªä»€éº¼ï¼Ÿ"></textarea>

                        <label class="form-label">å›æ‡‰ç¦±å‘Š (Response)</label>
                        <textarea id="dev-prayer" class="form-input" rows="3" placeholder="è¦ªæ„›çš„å¤©çˆ¶..."></textarea>
                        
                        <div class="text-center mt-4">
                            <button onclick="saveDevotion()" class="nature-btn">å„²å­˜ç­†è¨˜</button>
                        </div>
                    </div>
                </div>

                <div id="tab-prayer-list" class="chaplain-tab-content hidden fade-in">
                    <div class="bg-white/60 p-6 rounded-xl border border-gray-100 shadow-sm max-w-2xl mx-auto">
                        <p class="text-center text-sm text-[#8D7B68] mb-6">å½¼æ­¤ä»£æ±‚ï¼Œç¶“æ­·ç¥çš„å¤§èƒ½ã€‚</p>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="form-label">å°è±¡ (Target)</label>
                                <select id="pray-target" class="form-input">
                                    <option value="ç‚ºè‡ªå·±">ç‚ºè‡ªå·±</option>
                                    <option value="ç‚ºåˆ¥äºº">ç‚ºåˆ¥äºº</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">ç‹€æ…‹ (Status)</label>
                                <select id="pray-status" class="form-input">
                                    <option value="praying">ç¦±å‘Šä¸­ ğŸ™</option>
                                    <option value="answered">å·²æˆå°± ğŸ‰</option>
                                </select>
                            </div>
                        </div>

                        <label class="form-label">ç¦±å‘Šäº‹é … (Topic)</label>
                        <input id="pray-topic" type="text" class="form-input" placeholder="ä¾‹å¦‚ï¼šå·¥ä½œçš„æŒ‘æˆ°ã€å®¶äººçš„å¥åº·...">

                        <label class="form-label">ç¦±å‘Šå…§å®¹ (Content)</label>
                        <textarea id="pray-content" class="form-input" rows="3" placeholder="å…·é«”çš„ç¦±å‘Šå…§å®¹..."></textarea>

                        <div class="text-center mt-4 mb-8 flex justify-center gap-2">
                            <button id="btn-save-prayer" onclick="savePrayer()" class="nature-btn">åŠ å…¥ç¦±å‘Šäº‹é …</button>
                            <button id="btn-cancel-edit" onclick="cancelEdit()" class="nature-btn hidden border-red-300 text-red-400 hover:bg-red-50 hover:text-red-500">å–æ¶ˆç·¨è¼¯</button>
                        </div>

                        <div class="border-t border-gray-200 pt-6">
                            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                                <h4 class="font-bold text-[#6B8E23]">æˆ‘çš„ç¦±å‘Šæ¸…å–®</h4>
                                <div class="flex gap-2">
                                    <button onclick="setPrayerFilter('all')" id="filter-all" class="filter-btn active">å…¨éƒ¨</button>
                                    <button onclick="setPrayerFilter('praying')" id="filter-praying" class="filter-btn">ç¦±å‘Šä¸­</button>
                                    <button onclick="setPrayerFilter('answered')" id="filter-answered" class="filter-btn">å·²æˆå°±</button>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <input type="text" id="prayer-search" oninput="renderPrayerList()" placeholder="ğŸ” æœå°‹ç¦±å‘Šäº‹é …..." class="w-full px-4 py-2 rounded-full border border-gray-200 bg-white/50 focus:outline-none focus:border-[#6B8E23] text-sm">
                            </div>

                            <div id="prayer-list-display" class="space-y-2">
                                <!-- Prayer List Rendered Here -->
                                <p class="text-center text-gray-400 text-sm">ç›®å‰æ²’æœ‰ç´€éŒ„</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-gratitude" class="chaplain-tab-content hidden fade-in">
                    <div class="bg-white/60 p-6 rounded-xl border border-gray-100 shadow-sm max-w-2xl mx-auto">
                        <p class="text-center text-sm text-[#8D7B68] mb-6">æ•¸ç®—æ©å…¸ï¼Œçœ‹è¦‹ç¥çš„æ‰‹ã€‚</p>
                        <label class="form-label">ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿ(Event)</label>
                        <textarea id="grat-event" class="form-input" rows="3" placeholder="ç´€éŒ„ä¸€ä»¶ä»Šå¤©ç™¼ç”Ÿçš„å°äº‹..."></textarea>
                        
                        <label class="form-label">æˆ‘çœ‹è¦‹ç¥çš„ä½œç‚ºäº†å—ï¼Ÿ(God's Work)</label>
                        <textarea id="grat-god" class="form-input" rows="3" placeholder="ç¥åœ¨å…¶ä¸­åšäº†ä»€éº¼ï¼Œæˆ–æ•™æœƒäº†æˆ‘ä»€éº¼ï¼Ÿ"></textarea>
                        
                        <div class="text-center mt-4">
                            <button onclick="saveDiary('gratitude')" class="nature-btn">ç´€éŒ„æ©å…¸</button>
                        </div>
                    </div>
                </div>

                <div id="tab-emotion" class="chaplain-tab-content hidden fade-in">
                    <div class="bg-white/60 p-6 rounded-xl border border-gray-100 shadow-sm max-w-2xl mx-auto">
                        <p class="text-center text-sm text-[#8D7B68] mb-6">èª å¯¦é¢å°æƒ…ç·’ï¼Œå¸¶åˆ°ç¥é¢å‰ã€‚</p>
                        
                        <label class="form-label">äº‹ä»¶ (Event)</label>
                        <input id="emo-event" type="text" class="form-input" placeholder="ç™¼ç”Ÿäº†ä»€éº¼å¼•ç™¼æƒ…ç·’çš„äº‹ï¼Ÿ">

                        <label class="form-label">æƒ…ç·’æ¨™è¨» (Emotion)</label>
                        <div class="mb-4" id="emotion-tags">
                            ${emotionHtml}
                        </div>
                        <input type="hidden" id="emo-selected">

                        <label class="form-label">æˆ‘ä»¥ç‚º / æˆ‘ç›¸ä¿¡ (Belief)</label>
                        <textarea id="emo-belief" class="form-input" rows="2" placeholder="ç•¶ä¸‹æˆ‘å¿ƒè£¡æ˜¯æ€éº¼æƒ³çš„ï¼Ÿ"></textarea>

                        <label class="form-label">ç¥å¦‚ä½•çœ‹ (God's View)</label>
                        <textarea id="emo-god" class="form-input" rows="2" placeholder="ç¥çš„è©±èªæˆ–çœŸç†æ˜¯æ€éº¼èªªçš„ï¼Ÿ"></textarea>

                        <label class="form-label">å›æ‡‰ç¦±å‘Š (Prayer)</label>
                        <textarea id="emo-prayer" class="form-input" rows="3" placeholder="æ ¹æ“šæ–°çš„çœ‹è¦‹ï¼Œå‘ç¥ç¦±å‘Š..."></textarea>

                        <div class="text-center mt-4">
                            <button onclick="saveDiary('emotion')" class="nature-btn">å®Œæˆæ—¥è¨˜</button>
                        </div>
                    </div>
                </div>

                <div id="tab-letter" class="chaplain-tab-content hidden fade-in">
                    <div class="bg-white/60 p-6 rounded-xl border border-gray-100 shadow-sm max-w-2xl mx-auto">
                        <p class="text-center text-sm text-[#8D7B68] mb-6">å¯«çµ¦æœªä¾†çš„è‡ªå·±ï¼Œä¿¡å¿ƒçš„å®£å‘Šã€‚</p>
                        
                        <label class="form-label">å¯„é€æ—¥æœŸ (Future Date)</label>
                        <input id="letter-date" type="date" class="form-input">

                        <label class="form-label">æ”¶ä¿¡ä¿¡ç®± (Email) <span class="text-xs font-normal opacity-50">(ç›®å‰åƒ…ä¾›ç´€éŒ„)</span></label>
                        <input id="letter-email" type="email" class="form-input" placeholder="name@example.com">

                        <label class="form-label">çµ¦æœªä¾†çš„è‡ªå·± (Content)</label>
                        <textarea id="letter-content" class="form-input" rows="6" placeholder="æˆ‘æƒ³å°æœªä¾†çš„è‡ªå·±èªª..."></textarea>

                        <div class="text-center mt-4">
                            <button onclick="saveLetter()" class="nature-btn">æŠ•éä¿¡ä»¶</button>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = html;
            if(window.lucide) lucide.createIcons();
            renderPrayerList(); 
        }

        function refreshPrayer() {
            let p = null;
            if (prayersData.length > 0) {
                p = prayersData[Math.floor(Math.random() * prayersData.length)];
            } else {
                 const defaults = [
                    { title: "ä¸»ç¦±æ–‡", ref: "é¦¬å¤ªç¦éŸ³ 6:9-13", fullText: "æˆ‘å€‘åœ¨å¤©ä¸Šçš„çˆ¶ï¼š\né¡˜äººéƒ½å°Šä½ çš„åç‚ºè–ã€‚\né¡˜ä½ çš„åœ‹é™è‡¨ï¼›\né¡˜ä½ çš„æ—¨æ„è¡Œåœ¨åœ°ä¸Šï¼Œ\nå¦‚åŒè¡Œåœ¨å¤©ä¸Šã€‚\næˆ‘å€‘æ—¥ç”¨çš„é£²é£Ÿï¼Œä»Šæ—¥è³œçµ¦æˆ‘å€‘ã€‚\nå…æˆ‘å€‘çš„å‚µï¼Œå¦‚åŒæˆ‘å€‘å…äº†äººçš„å‚µã€‚\nä¸å«æˆ‘å€‘é‡è¦‹è©¦æ¢ï¼›\næ•‘æˆ‘å€‘è„«é›¢å…‡æƒ¡ã€‚\nå› ç‚ºåœ‹åº¦ã€æ¬ŠæŸ„ã€æ¦®è€€ï¼Œå…¨æ˜¯ä½ çš„ï¼Œ\nç›´åˆ°æ°¸é ã€‚é˜¿å€‘ã€‚" },
                    { title: "å°¼å¸ƒçˆ¾çš„å¯§éœç¦±æ–‡", ref: "Reinhold Niebuhr", fullText: "ç¥å•Šï¼Œ\nè«‹è³œçµ¦æˆ‘å¯§éœï¼Œ\nå»æ¥å—æˆ‘ç„¡æ³•æ”¹è®Šçš„äº‹ï¼›\nè³œçµ¦æˆ‘å‹‡æ°£ï¼Œ\nå»æ”¹è®Šæˆ‘èƒ½æ”¹è®Šçš„äº‹ï¼›\nä¸¦è³œçµ¦æˆ‘æ™ºæ…§ï¼Œ\nå»åˆ†è¾¨é€™å…©è€…çš„å·®åˆ¥ã€‚" }
                ];
                p = defaults[Math.floor(Math.random() * defaults.length)];
            }

            const title = p.title || p.Title || "ä»Šæ—¥ç¦±å‘Š";
            const ref = p.ref || p.Ref || "";
            const text = p.fullText || p.fulltext || p.Fulltext || p.content || "";

            const display = document.getElementById('daily-prayer-display');
            if (display) {
                display.innerHTML = `
                      <div class="flex flex-col items-center text-center mb-6 fade-in">
                        <h3 class="text-xl font-bold text-[#6B8E23] mb-2">${title}</h3>
                        <span class="text-xs text-gray-400 border border-gray-300 rounded px-2 py-0.5">${ref}</span>
                    </div>
                    <p class="text-[#585858] leading-relaxed whitespace-pre-wrap mb-6 font-light fade-in text-center">${text}</p>
                    <div class="text-center">
                        <button onclick="refreshPrayer()" class="text-xs text-[#8D7B68] hover:text-[#6B8E23] flex items-center justify-center gap-1 mx-auto transition-colors">
                            <i data-lucide="refresh-cw" class="w-3 h-3"></i> æ›ä¸€å‰‡ç¦±å‘Š
                        </button>
                    </div>
                `;
                if(window.lucide) lucide.createIcons();
            }
        }

        function switchChaplainTab(tabId, btn) {
            document.querySelectorAll('.chaplain-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.chaplain-tab-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            
            if(tabId === 'tab-prayer-list') {
                renderPrayerList();
            }
        }

        function toggleEmotion(el) {
            el.classList.toggle('selected');
        }

        function saveDiary(type) {
            const today = new Date().toLocaleDateString();
            let data = {};
            let storeKey = '';
            
            if (type === 'gratitude') {
                const event = document.getElementById('grat-event').value;
                const god = document.getElementById('grat-god').value;
                if(!event) { showModalInfo("æç¤º", "è«‹å¡«å¯«ç™¼ç”Ÿçš„äº‹"); return; }
                data = { id: Date.now(), date: today, event, god };
                storeKey = 'witty_gratitude';
                
                // Clear
                document.getElementById('grat-event').value = '';
                document.getElementById('grat-god').value = '';
            } else {
                const event = document.getElementById('emo-event').value;
                const belief = document.getElementById('emo-belief').value;
                const god = document.getElementById('emo-god').value;
                const prayer = document.getElementById('emo-prayer').value;
                // Get selected emotions
                const emotions = Array.from(document.querySelectorAll('.emotion-chip.selected')).map(el => el.innerText);
                
                if(!event) { showModalInfo("æç¤º", "è«‹å¡«å¯«äº‹ä»¶"); return; }
                
                data = { id: Date.now(), date: today, event, emotions, belief, god, prayer };
                storeKey = 'witty_emotions';
                
                // Clear
                document.getElementById('emo-event').value = '';
                document.getElementById('emo-belief').value = '';
                document.getElementById('emo-god').value = '';
                document.getElementById('emo-prayer').value = '';
                document.querySelectorAll('.emotion-chip').forEach(c => c.classList.remove('selected'));
            }
            
            const list = JSON.parse(localStorage.getItem(storeKey) || '[]');
            list.unshift(data);
            localStorage.setItem(storeKey, JSON.stringify(list));
            
            showModalInfo("ç´€éŒ„æˆåŠŸ", type === 'gratitude' ? "æ„Ÿæ©æ—¥è¨˜å·²å„²å­˜" : "æƒ…ç·’æ—¥è¨˜å·²å„²å­˜");
        }

        function saveDevotion() {
            const summary = document.getElementById('dev-summary').value;
            const verse = document.getElementById('dev-verse').value;
            const app = document.getElementById('dev-app').value;
            const heart = document.getElementById('dev-heart').value;
            const prayer = document.getElementById('dev-prayer').value;
            
            if(!summary && !verse) {
                showModalInfo("è«‹å¡«å¯«å…§å®¹", "è«‹è‡³å°‘å¯«ä¸‹ç¶“æ–‡å¤§æ„æˆ–æ„Ÿå‹•ç¶“æ–‡å–”ï¼");
                return;
            }

            const data = {
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                summary, verse, app, heart, prayer
            };

            const list = JSON.parse(localStorage.getItem('witty_devotions') || '[]');
            list.unshift(data);
            localStorage.setItem('witty_devotions', JSON.stringify(list));

            // Clear inputs
            document.getElementById('dev-summary').value = '';
            document.getElementById('dev-verse').value = '';
            document.getElementById('dev-app').value = '';
            document.getElementById('dev-heart').value = '';
            document.getElementById('dev-prayer').value = '';

            showModalInfo("éˆä¿®ç­†è¨˜å·²å„²å­˜", "é¡˜ç¥çš„è©±èªæˆç‚ºä½ è…³å‰çš„ç‡ˆï¼Œè·¯ä¸Šçš„å…‰ã€‚");
        }

        // Backup and Import Functions
        function exportData() {
            const data = {
                prayers: JSON.parse(localStorage.getItem('witty_prayers') || '[]'),
                letters: JSON.parse(localStorage.getItem('witty_letters') || '[]'),
                devotions: JSON.parse(localStorage.getItem('witty_devotions') || '[]'),
                gratitude: JSON.parse(localStorage.getItem('witty_gratitude') || '[]'),
                emotions: JSON.parse(localStorage.getItem('witty_emotions') || '[]'),
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `witty_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.prayers) localStorage.setItem('witty_prayers', JSON.stringify(data.prayers));
                    if (data.letters) localStorage.setItem('witty_letters', JSON.stringify(data.letters));
                    if (data.devotions) localStorage.setItem('witty_devotions', JSON.stringify(data.devotions));
                    if (data.gratitude) localStorage.setItem('witty_gratitude', JSON.stringify(data.gratitude));
                    if (data.emotions) localStorage.setItem('witty_emotions', JSON.stringify(data.emotions));
                    
                    showModalInfo("åŒ¯å…¥æˆåŠŸ", "è³‡æ–™å·²æˆåŠŸé‚„åŸï¼é é¢å°‡é‡æ–°æ•´ç†ã€‚");
                    setTimeout(() => location.reload(), 2000);
                } catch (err) {
                    showModalInfo("åŒ¯å…¥å¤±æ•—", "æª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–ææ¯€ã€‚");
                }
            };
            reader.readAsText(file);
            input.value = ''; // reset
        }

        function savePrayer() {
            const topic = document.getElementById('pray-topic').value;
            const content = document.getElementById('pray-content').value;
            const target = document.getElementById('pray-target').value;
            const status = document.getElementById('pray-status').value;

            if(!topic) {
                showModalInfo("è«‹å¡«å¯«äº‹é …", "ç¦±å‘Šäº‹é …æ˜¯å¿…å¡«çš„å–”ï¼");
                return;
            }

            const prayers = JSON.parse(localStorage.getItem('witty_prayers') || '[]');

            if (editingPrayerId) {
                // Update Existing
                const idx = prayers.findIndex(p => p.id === editingPrayerId);
                if (idx !== -1) {
                    prayers[idx].topic = topic;
                    prayers[idx].content = content;
                    prayers[idx].target = target;
                    prayers[idx].status = status;
                    // Don't update date to keep history, or update if user prefers. Keeping original for now.
                }
                showModalInfo("æ›´æ–°æˆåŠŸ", "ç¦±å‘Šç´€éŒ„å·²æ›´æ–°ï¼");
            } else {
                // Create New
                const newPrayer = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString(),
                    topic,
                    content,
                    target,
                    status
                };
                prayers.unshift(newPrayer);
                showModalInfo("ç¦±å‘Šå·²ç´€éŒ„", "æˆ‘å€‘çŸ¥é“ç¥è½æˆ‘å€‘çš„ç¦±å‘Šï¼Œé€™æ˜¯æˆ‘å€‘å‘ç¥‚æ‰€å­˜å¦ç„¶ç„¡æ‡¼çš„å¿ƒã€‚");
            }

            localStorage.setItem('witty_prayers', JSON.stringify(prayers));
            cancelEdit(); // Reset form
            renderPrayerList();
        }

        function editPrayer(id) {
            const prayers = JSON.parse(localStorage.getItem('witty_prayers') || '[]');
            const prayer = prayers.find(p => p.id === id);
            if (!prayer) return;

            // Fill inputs
            document.getElementById('pray-topic').value = prayer.topic;
            document.getElementById('pray-content').value = prayer.content;
            document.getElementById('pray-target').value = prayer.target;
            document.getElementById('pray-status').value = prayer.status;

            // Set Edit Mode
            editingPrayerId = id;
            document.getElementById('btn-save-prayer').textContent = "æ›´æ–°ç´€éŒ„";
            document.getElementById('btn-cancel-edit').classList.remove('hidden');

            // Scroll to form
            document.getElementById('tab-prayer-list').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            editingPrayerId = null;
            document.getElementById('pray-topic').value = '';
            document.getElementById('pray-content').value = '';
            document.getElementById('btn-save-prayer').textContent = "åŠ å…¥ç¦±å‘Šäº‹é …";
            document.getElementById('btn-cancel-edit').classList.add('hidden');
        }

        function setPrayerFilter(filter) {
            currentPrayerFilter = filter;
            // Update UI buttons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${filter}`).classList.add('active');
            renderPrayerList();
        }

        function renderPrayerList() {
            const container = document.getElementById('prayer-list-display');
            if(!container) return;
            
            const allPrayers = JSON.parse(localStorage.getItem('witty_prayers') || '[]');
            const searchTerm = document.getElementById('prayer-search') ? document.getElementById('prayer-search').value.toLowerCase() : '';
            
            // Filter Logic
            const prayers = allPrayers.filter(p => {
                const matchesFilter = currentPrayerFilter === 'all' || p.status === currentPrayerFilter;
                const matchesSearch = !searchTerm || p.topic.toLowerCase().includes(searchTerm) || p.content.toLowerCase().includes(searchTerm);
                return matchesFilter && matchesSearch;
            });
            
            if(prayers.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç¦±å‘Šç´€éŒ„</p>';
                return;
            }

            let html = '';
            prayers.forEach(p => {
                const isAnswered = p.status === 'answered';
                const statusBadge = isAnswered 
                    ? '<span class="prayer-status-badge bg-green-100 text-green-700 border border-green-300">å·²æˆå°± ğŸ‰</span>' 
                    : '<span class="prayer-status-badge bg-yellow-100 text-yellow-700 border border-yellow-300">ç¦±å‘Šä¸­ ğŸ™</span>';
                
                const cardClass = isAnswered ? 'prayer-item-card answered' : 'prayer-item-card';

                html += `
                    <div class="${cardClass}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="text-xs text-gray-500 mr-2">${p.date}</span>
                                <span class="text-xs font-bold text-[#8D7B68] border border-[#8D7B68] px-1 rounded">${p.target}</span>
                            </div>
                            ${statusBadge}
                        </div>
                        <h4 class="font-bold text-[#3E3B39] mb-1">${p.topic}</h4>
                        ${p.content ? `<p class="text-sm text-gray-600 mb-3 whitespace-pre-wrap">${p.content}</p>` : ''}
                        
                        <div class="flex justify-end gap-2 mt-2 border-t border-gray-200/50 pt-2">
                            <button onclick="editPrayer(${p.id})" class="text-xs text-[#6B8E23] hover:underline flex items-center gap-1"><i data-lucide="edit-2" class="w-3 h-3"></i> ç·¨è¼¯</button>
                            <button onclick="deletePrayer(${p.id})" class="text-xs text-red-400 hover:text-red-600 hover:underline flex items-center gap-1"><i data-lucide="trash-2" class="w-3 h-3"></i> åˆªé™¤</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            if(window.lucide) lucide.createIcons();
        }

        function deletePrayer(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç¦±å‘Šç´€éŒ„å—ï¼Ÿ')) {
                const prayers = JSON.parse(localStorage.getItem('witty_prayers') || '[]');
                const newPrayers = prayers.filter(p => p.id !== id);
                localStorage.setItem('witty_prayers', JSON.stringify(newPrayers));
                renderPrayerList();
            }
        }

        function saveLetter() {
            const date = document.getElementById('letter-date').value;
            const content = document.getElementById('letter-content').value;
            if(!date || !content) {
                showModalInfo("è«‹å¡«å¯«å®Œæ•´", "æ—¥æœŸèˆ‡å…§å®¹æ˜¯å¿…å¡«çš„å–”ï¼");
                return;
            }
            
            // Save to local storage for "Time Capsule" check
            const letters = JSON.parse(localStorage.getItem('witty_letters') || '[]');
            letters.push({ date: date, content: content, read: false });
            localStorage.setItem('witty_letters', JSON.stringify(letters));

            document.getElementById('letter-content').value = '';
            showModalInfo("ä¿¡ä»¶å·²æŠ•é", `é€™å°ä¿¡å°‡åœ¨ ${date} é€é”çµ¦æœªä¾†çš„ä½ ã€‚`);
        }

        function checkFutureLetters() {
            const letters = JSON.parse(localStorage.getItem('witty_letters') || '[]');
            const today = new Date().toISOString().split('T')[0];
            let hasLetter = false;

            letters.forEach((l, idx) => {
                if (!l.read && l.date <= today) {
                    // Found a letter!
                    showModalInfo("æ”¶åˆ°ä¸€å°ä¾†è‡ªéå»çš„ä¿¡", l.content);
                    l.read = true;
                    hasLetter = true;
                }
            });

            if (hasLetter) {
                localStorage.setItem('witty_letters', JSON.stringify(letters));
            }
        }

        function showModalInfo(title, text) {
            const modal = document.getElementById('bible-modal');
            const mTitle = document.getElementById('modal-title');
            const mBody = document.getElementById('modal-body');
            mTitle.innerText = title;
            mBody.innerHTML = `<p class="whitespace-pre-wrap">${text}</p>
            <div class="text-center mt-6">
                <button onclick="closeBibleModal()" class="nature-btn">é—œé–‰</button>
            </div>`;
            modal.classList.add('show');
        }

        async function initBibleDB() {
            if (db) return db;
            if (isDbLoading) return new Promise(resolve => {
                const check = setInterval(() => { if(db || !isDbLoading) { clearInterval(check); resolve(db); } }, 100);
            });

            isDbLoading = true;
            try {
                const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.wasm` });
                const response = await fetch(BIBLE_DB_URL);
                if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const buffer = await response.arrayBuffer();
                db = new SQL.Database(new Uint8Array(buffer));
                console.log("Bible DB Loaded");
                
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table'")[0].values;
                let validTable = tables.find(t => /bible|verse|scripture/i.test(t[0]));
                if (!validTable) validTable = tables.find(t => t[0] !== 'sqlite_sequence');
                const tableName = validTable ? validTable[0] : tables[0][0];
                
                const cols = db.exec(`PRAGMA table_info(${tableName})`)[0].values.map(r=>r[1]);
                console.log("DB Table:", tableName, "Cols:", cols);
                
                dbCols = {
                    tableName: tableName,
                    book: cols.find(c => /book|b|æ›¸|vol/i.test(c)) || cols[0],
                    chap: cols.find(c => /chapter|chap|c|ç« /i.test(c)) || cols[1],
                    ver: cols.find(c => /verse|v|ç¯€/i.test(c)) || cols[2],
                    text: cols.find(c => /lection|content|text|scripture|ç¶“æ–‡|ç¶“æ–‡/i.test(c)) || cols[cols.length - 1]
                };

                return db;
            } catch (err) {
                console.error("DB Error", err);
                const container = document.getElementById('bible-display-area');
                if(container) container.innerHTML = `<p class="text-red-500 text-center py-10">è³‡æ–™åº«è®€å–å¤±æ•— (${err.message})<br>è«‹é‡æ–°æ•´ç†æˆ–æª¢æŸ¥ç¶²è·¯ã€‚</p>`;
                return null;
            } finally {
                isDbLoading = false;
            }
        }

        async function renderBibleBrowserHome() {
            const container = document.getElementById('bible-display-area');
            if (!db) {
                container.innerHTML = '<div class="flex flex-col items-center py-10 text-gray-500"><i data-lucide="loader-2" class="animate-spin w-8 h-8 mb-2"></i><p>æ­£åœ¨æ¬é‹è–ç¶“æ›¸å·...</p></div>';
                if(window.lucide) lucide.createIcons();
                await initBibleDB();
                if (!db) return;
            }

            try {
                const res = db.exec(`SELECT DISTINCT ${dbCols.book} FROM ${dbCols.tableName}`);
                const books = res[0].values.flat();
                bibleBooksCache = books;

                let html = '<div class="bible-book-grid">';
                books.forEach(book => {
                    html += `<div class="bible-book-item" onclick="renderChapters('${book}')">${book}</div>`;
                });
                html += '</div>';
                container.innerHTML = html;

            } catch (e) {
                container.innerHTML = `<p class="text-red-500 text-center">ç™¼ç”ŸéŒ¯èª¤: ${e.message}</p>`;
            }
        }

        function renderChapters(bookName) {
            const container = document.getElementById('bible-display-area');
            try {
                const res = db.exec(`SELECT DISTINCT ${dbCols.chap} FROM ${dbCols.tableName} WHERE ${dbCols.book} = '${bookName}'`);
                const chapters = res[0].values.flat();

                let html = `
                    <div class="mb-4 flex items-center gap-2">
                        <button onclick="renderBibleBrowserHome()" class="text-sm text-[#6B8E23] hover:underline">
                            <i data-lucide="arrow-left" class="w-3 h-3 inline"></i> è¿”å›æ›¸å·
                        </button>
                        <span class="text-[#3E3B39] font-bold"> > ${bookName}</span>
                    </div>
                    <div class="chapter-grid">
                `;
                chapters.forEach(chap => {
                    html += `<div class="chapter-item" onclick="openScripture('${bookName} ${chap}')">${chap}</div>`;
                });
                html += '</div>';
                container.innerHTML = html;
                if(window.lucide) lucide.createIcons();

            } catch (e) {
                console.error(e);
            }
        }

        function handleSearch(e) { if(e.key === 'Enter') performSearch(); }
        
        function performSearch() {
            const keyword = document.getElementById('bible-search-input').value.trim();
            const container = document.getElementById('bible-display-area');
            if(!keyword) { renderBibleBrowserHome(); return; }
            if(!db) return;

            try {
                const query = `SELECT ${dbCols.book}, ${dbCols.chap}, ${dbCols.ver}, ${dbCols.text} FROM ${dbCols.tableName} WHERE ${dbCols.text} LIKE '%${keyword}%' LIMIT 50`;
                const res = db.exec(query);

                if (res.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 mt-10">æ‰¾ä¸åˆ°åŒ…å«ã€Œ${keyword}ã€çš„ç¶“æ–‡ã€‚</p><button onclick="renderBibleBrowserHome()" class="block mx-auto mt-4 text-[#6B8E23]">è¿”å›ç›®éŒ„</button>`;
                    return;
                }

                const rows = res[0].values;
                let html = `
                    <div class="mb-4 flex justify-between items-center">
                        <span class="text-sm text-gray-500">æœå°‹çµæœ: ${rows.length} ç­†</span>
                        <button onclick="renderBibleBrowserHome()" class="text-sm text-[#6B8E23]">è¿”å›ç›®éŒ„</button>
                    </div>
                    <div class="space-y-2">
                `;
                
                rows.forEach(row => {
                    const b = row[0], c = row[1], v = row[2], t = row[3];
                    html += `
                        <div class="search-result-item" onclick="openScripture('${b} ${c}', ${v})">
                            <div class="text-xs text-[#6B8E23] font-bold mb-1">${b} ${c}:${v}</div>
                            <div class="text-[#3E3B39] text-sm">${t}</div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;

            } catch (e) {
                console.error(e);
            }
        }

        async function fetchBlessingVerses() {
            try {
                const res = await fetch(BLESSING_VERSES_URL);
                if(!res.ok) throw new Error("Failed");
                const data = await res.json();
                if(Array.isArray(data) && data.length > 0) {
                    const randomVerse = data[Math.floor(Math.random() * data.length)];
                    renderBlessingCard(randomVerse);
                }
            } catch (e) {
                const area = document.getElementById('blessing-card-area');
                if(area) area.innerHTML = '<p class="text-center text-gray-400">ä»Šæ—¥é‡‘å¥é‹é€ä¸­...</p>';
            }
        }

        function renderBlessingCard(item) {
            const container = document.getElementById('blessing-card-area');
            const text = item['å®Œæ•´ç¶“æ–‡'] || item['scripture'] || 'No Text';
            
            // Try to find a specific reference field
            const ref = item['ref'] || item['reference'] || item['å‡ºè™•'] || item['source'] || '';
            
            // If ref exists, use it. Otherwise use the full text and let the parser handle it.
            const targetForOpen = ref ? ref : text;
            
            const safeText = targetForOpen.replace(/'/g, "\\'").replace(/\n/g, ' ');

            container.innerHTML = `
                <div class="verse-card-highlight">
                    <p class="text-xl font-serif text-[#3E3B39] leading-relaxed mb-6">${text}</p>
                    <button onclick="openScriptureByText('${safeText}')" class="nature-btn">
                        <i data-lucide="book-open" class="w-4 h-4"></i>
                        <span>é–±è®€æ•´ç« </span>
                    </button>
                </div>
            `;
            if(window.lucide) lucide.createIcons();
        }

        /**
         * æ™ºæ…§ç¶“æ–‡è§£æå™¨
         * èƒ½å¾æ··é›œçš„æ–‡å­—ä¸­æŠ“å‡º "æ›¸å· ç« :ç¯€" æˆ– "æ›¸å· ç« "
         * ä¿®æ­£ï¼šå…è¨±æ›¸å·èˆ‡ç« ç¯€ä¹‹é–“æ²’æœ‰ç©ºæ ¼ (é‡å°ä¸­æ–‡ä½¿ç”¨è€…ç¿’æ…£)
         */
        function parseBibleReference(text) {
            if (!text) return null;
            
            // 1. é è™•ç†ï¼šç§»é™¤æ‹¬è™Ÿï¼Œå°‡å…¨å½¢ç¬¦è™Ÿè½‰åŠå½¢
            text = text.replace(/[\(\)\uff08\uff09]/g, ' ')
                       .replace(/ï¼š/g, ':')
                       .trim();

            // 2. å®šç¾©æ›¸å·åç¨±çš„æ­£å‰‡ (æ”¯æ´ä¸­æ–‡1-15å­— æˆ– è‹±æ–‡+æ•¸å­—å‰ç¶´)
            const bookPat = "([1-3]?\\s?[\\u4e00-\\u9fa5]{1,15}|[1-3]?\\s?[a-zA-Z]+)";
            
            // 3. å®šç¾©ç« ç¯€æ ¼å¼
            // æ ¼å¼ A: ç« :ç¯€-ç¯€ (1:1-5)
            // æ ¼å¼ B: ç« :ç¯€ (1:1)
            const chapVersePat = "(\\d+)\\s*:\\s*(\\d+)(?:\\s*[-â€“~]\\s*(\\d+))?";
            
            // 4. å˜—è©¦æœå°‹ "æ›¸å· ç« :ç¯€" æ¨¡å¼ (å„ªå…ˆç´šæœ€é«˜)
            // ä¿®æ­£ï¼šä½¿ç”¨ \\s* å…è¨±ç„¡ç©ºæ ¼ (ä¾‹å¦‚ "ç´„3:16")
            const cvRegex = new RegExp(`${bookPat}\\s*${chapVersePat}`, 'g');
            let match;
            let lastMatch = null;
            
            while ((match = cvRegex.exec(text)) !== null) {
                lastMatch = match;
            }

            if (lastMatch) {
                return {
                    book: lastMatch[1].trim(),
                    chapter: parseInt(lastMatch[2]),
                    verse: parseInt(lastMatch[3]),
                    endVerse: lastMatch[4] ? parseInt(lastMatch[4]) : parseInt(lastMatch[3])
                };
            }

            // 5. å˜—è©¦æœå°‹ "æ›¸å· ç« -ç« " (è·¨ç« ç¯„åœï¼Œå„ªå…ˆæ¬Šæ¬¡ä¹‹)
            // æ ¼å¼ C: ç« -ç«  (1-2)
            const chapRangePat = "(\\d+)\\s*[-â€“~]\\s*(\\d+)";
            const rangeRegex = new RegExp(`${bookPat}\\s*${chapRangePat}`, 'g');
            let matchRange;
            let lastMatchRange = null;
            while ((matchRange = rangeRegex.exec(text)) !== null) { lastMatchRange = matchRange; }
            
            if (lastMatchRange) {
                 return {
                    book: lastMatchRange[1].trim(),
                    chapter: parseInt(lastMatchRange[2]),
                    verse: 1,
                    endChapter: parseInt(lastMatchRange[3]) // Special field for multi-chapter
                };
            }

            // 6. å¦‚æœæ²’æ‰¾åˆ° "ç« :ç¯€" æˆ– "ç« -ç« "ï¼Œå˜—è©¦æ‰¾ "æ›¸å· ç« " (ä¾‹å¦‚ï¼šè©©ç¯‡ 23)
            // é€™è£¡é‚„æ˜¯å»ºè­°ä¿ç•™è‡³å°‘ä¸€å€‹ç©ºæ ¼ï¼Œé¿å… "å‰µä¸–è¨˜1" è¢«èª¤åˆ¤ (é›–ç„¶ \d+ æœƒåƒæ‰æ•¸å­—ï¼Œä½†æ›¸å·åçµå°¾å¯èƒ½æœ‰æ•¸å­—çš„æƒ…æ³è¼ƒå°‘)
            // ä½†ç‚ºäº†ä¿éšªï¼Œæˆ‘å€‘å¯ä»¥ç”¨ \\s* ä½†é™åˆ¶çµå°¾
            const chapRegex = new RegExp(`${bookPat}\\s*(\\d+)\\s*$`, 'g'); 
            while ((match = chapRegex.exec(text)) !== null) {
                lastMatch = match;
            }
            
            if (lastMatch) {
                return {
                    book: lastMatch[1].trim(),
                    chapter: parseInt(lastMatch[2]),
                    verse: 1, // é è¨­è·³è½‰åˆ°ç¬¬ä¸€ç¯€
                    endVerse: null
                };
            }

            return null;
        }

        /**
         * æ ¹æ“šæ–‡å­—å…§å®¹é–‹å•Ÿç¶“æ–‡ (Entry Point)
         */
        function openScriptureByText(text) {
            // 1. å˜—è©¦ä½¿ç”¨æ™ºæ…§è§£æå™¨
            const parsed = parseBibleReference(text);
            
            if (parsed) {
                // å¦‚æœè§£ææˆåŠŸï¼Œçµ„åˆæˆæ¨™æº–æ ¼å¼å‚³çµ¦ openScripture
                const refStr = `${parsed.book} ${parsed.chapter}:${parsed.verse}`;
                // å¦‚æœæœ‰è·¨ç« ï¼Œé€™è£¡å¯èƒ½éœ€è¦ç‰¹æ®Šè™•ç†ï¼Œä½† openScripture ä¸»è¦æ˜¯é å†æ¬¡è§£æ refStr
                // æ‰€ä»¥å¦‚æœæˆ‘å€‘ç›´æ¥å‚³åŸå§‹æ–‡å­—å¯èƒ½æ›´å¥½ï¼Ÿ
                // ä¸ï¼Œç‚ºäº†ç¢ºä¿ parseBibleReference çš„æ”¹é€²èƒ½ç”Ÿæ•ˆï¼Œæˆ‘å€‘ç›´æ¥ç”¨ parsed ç‰©ä»¶å‘¼å« openScripture é‚è¼¯æœƒæ›´ç©©
                // ä½†ç‚ºäº†ä¸ç ´å£ç¾æœ‰æ¶æ§‹ï¼Œæˆ‘å€‘ç›´æ¥å‚³åŸå§‹ text çµ¦ openScriptureï¼Œå› ç‚º openScripture å…§éƒ¨ä¹Ÿæœƒå‘¼å« parseBibleReference
                openScripture(text);
            } else {
                // å¦‚æœè§£æå¤±æ•—ï¼ˆä¾‹å¦‚åªçµ¦äº†æ›¸å·åï¼Œæˆ–è€…æ ¼å¼å¤ªäº‚ï¼‰ï¼Œ
                // é‚„æ˜¯å˜—è©¦ç›´æ¥ä¸Ÿé€²å»ï¼Œæ­»é¦¬ç•¶æ´»é¦¬é†«ï¼Œæˆ–è€…é¡¯ç¤ºæç¤º
                openScripture(text);
            }
        }

        async function openScripture(reference, highlightVerse = null) {
            const modal = document.getElementById('bible-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modal.classList.add('show');
            modalBody.innerHTML = `<div class="flex justify-center py-10"><i data-lucide="loader-2" class="w-8 h-8 animate-spin text-[#8D7B68]"></i></div>`;
            if(window.lucide) lucide.createIcons();

            const database = await initBibleDB();
            if (!database) { 
                modalBody.innerHTML = `<p class="text-center text-red-500">ç„¡æ³•è®€å–è³‡æ–™åº«ã€‚</p>`; 
                return; 
            }

            try {
                let bookName, startChap, startVer, endVer, endChap;
                
                // ä½¿ç”¨åŒæ¨£çš„è§£æé‚è¼¯ä¾†æ‹†è§£
                const parsed = parseBibleReference(reference);
                
                if (parsed) {
                    bookName = parsed.book;
                    startChap = parsed.chapter;
                    startVer = parsed.verse;
                    endVer = parsed.endVerse || startVer;
                    endChap = parsed.endChapter || startChap; // Handle cross-chapter
                    
                    let query;
                    
                    // å¦‚æœæ˜¯è·¨ç« ç¯€ (ä¾‹å¦‚ 1-2 ç« )
                    if (endChap > startChap) {
                         query = `SELECT ${dbCols.chap}, ${dbCols.ver}, ${dbCols.text} FROM ${dbCols.tableName} WHERE ${dbCols.book} LIKE '%${bookName}%' AND ${dbCols.chap} >= ${startChap} AND ${dbCols.chap} <= ${endChap} ORDER BY ${dbCols.chap}, ${dbCols.ver}`;
                    } else {
                        // å–®ç« 
                         query = `SELECT ${dbCols.chap}, ${dbCols.ver}, ${dbCols.text} FROM ${dbCols.tableName} WHERE ${dbCols.book} LIKE '%${bookName}%' AND ${dbCols.chap} = ${startChap} ORDER BY ${dbCols.ver}`;
                    }
                    
                    const res = database.exec(query);
                    
                    if (res.length > 0) {
                        let html = '';
                        let currentChap = 0;
                        
                        res[0].values.forEach(row => {
                            const c = row[0], v = row[1], t = row[2];
                            
                            // Add Chapter Header if new chapter
                            if (c !== currentChap) {
                                if (currentChap !== 0) html += '<br/><hr class="my-6 border-gray-200"/><br/>';
                                html += `<div class="text-left mb-4"><span class="text-lg font-bold text-[#6B8E23] bg-[#F1F3F2] px-4 py-1 rounded-full">ç¬¬ ${c} ç« </span></div>`;
                                currentChap = c;
                            }
                            
                            // åˆ¤æ–·æ˜¯å¦éœ€è¦é«˜äº®
                            let isHighlight = false;
                            
                            // 1. æ˜ç¢ºå‚³å…¥ (æœå°‹çµæœ)
                            if (highlightVerse && v == highlightVerse && c == startChap) isHighlight = true;
                            
                            // 2. è§£æå‡ºçš„ç¯„åœ (ä»Šæ—¥ç¶“å¥ 1:1-3) - åƒ…åœ¨å–®ç« æ¨¡å¼ä¸‹é«˜äº®ï¼Œé¿å…è·¨ç« å…¨äº®
                            else if (!highlightVerse && parsed.endVerse && startChap === endChap && v >= startVer && v <= endVer) {
                                isHighlight = true;
                            }

                            const highlightClass = isHighlight ? 'bg-yellow-100/80 p-2 rounded -mx-2 transition-all duration-500' : '';
                            const idAttr = isHighlight ? `id="target-verse"` : ''; 
                            
                            html += `<p ${idAttr} class="verse-text ${highlightClass}"><span class="verse-num">${v}</span>${t}</p>`;
                        });
                        
                        const titleSuffix = endChap > startChap ? `ç¬¬ ${startChap}-${endChap} ç« ` : `ç¬¬ ${startChap} ç« `;
                        modalTitle.innerHTML = `${bookName} ${titleSuffix}`;
                        modalBody.innerHTML = html;
                        
                        // è‡ªå‹•æ²å‹•åˆ°ç›®æ¨™ç¶“æ–‡
                        setTimeout(() => {
                            const target = document.getElementById('target-verse');
                            if(target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);

                    } else {
                        modalTitle.innerText = "æŸ¥ç„¡è³‡æ–™";
                        modalBody.innerHTML = `
                            <div class="text-center py-8">
                                <p class="mb-2">æ‰¾ä¸åˆ°æ›¸å·ï¼š<span class="font-bold text-red-500">${bookName}</span></p>
                                <p class="text-sm text-gray-400">è«‹å˜—è©¦ä½¿ç”¨å®Œæ•´çš„æ›¸å·åç¨±</p>
                            </div>`;
                    }
                } else {
                    // å®Œå…¨ç„¡æ³•è§£æ
                    modalTitle.innerText = "æ ¼å¼ç„¡æ³•è¾¨è­˜";
                    modalBody.innerHTML = `<p class="text-center py-4">ç„¡æ³•å¾ã€Œ${reference}ã€ä¸­è¾¨è­˜å‡ºç¶“æ–‡å‡ºè™•ã€‚</p>`;
                }

            } catch (e) {
                console.error(e);
                modalBody.innerHTML = `<p class="text-center text-red-500">æŸ¥è©¢ç™¼ç”ŸéŒ¯èª¤ï¼š${e.message}</p>`;
            }
            if(window.lucide) lucide.createIcons();
        }

        function closeBibleModal(event) {
            if (event && event.target.closest('.modal-content') && event.target.id !== 'bible-modal') return;
            document.getElementById('bible-modal').classList.remove('show');
        }

        function switchTab(targetId) {
            window.scrollTo({ top: 0, behavior: 'instant' });
            
            // Hide all sections
            const sections = document.querySelectorAll('.page-section');
            sections.forEach(sec => {
                sec.classList.add('hidden');
                sec.classList.remove('fade-in');
            });
            
            // Show target section
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                void targetSection.offsetWidth; 
                targetSection.classList.add('fade-in');
            }
            
            // Update Nav
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            let btnId = 'nav-today';
            if(targetId.includes('verses')) btnId = 'nav-verses';
            else if(targetId.includes('prayers')) btnId = 'nav-prayers';
            else if(targetId.includes('school')) btnId = 'nav-school';
            else if(targetId.includes('games')) btnId = 'nav-games';
            
            const btn = document.getElementById(btnId);
            if(btn) btn.classList.add('active');
            
            // --- Reset Logic ---
            if (targetId === 'section-today') {
                if(window.devotionalsData && window.devotionalsData.length > 0) resetDailyView();
            }
            else if (targetId === 'section-verses') {
                // FORCE RESET LIBRARY
                const searchInput = document.getElementById('bible-search-input');
                if(searchInput) searchInput.value = '';
                
                const area = document.getElementById('bible-display-area');
                // Only render if needed or force it? User requested reset on leaving and coming back.
                // Let's force render home to be sure it's reset.
                renderBibleBrowserHome();
            }
            else if (targetId === 'section-prayers') {
                renderChaplainOffice();
            }
            else if (targetId === 'section-school') {
                exitQuiz(); // Reset to menu
            }
        }

        async function fetchData() {
            const loadingEl = document.getElementById('loading');
            const mainContent = document.getElementById('main-content');
            try {
                const response = await fetch(DEVOTION_DATA_URL);
                const data = await response.json();
                loadingEl.style.display = 'none';
                mainContent.classList.remove('opacity-0');
                const categorized = categorizeData(data);
                devotionalsData = categorized.devotionals; 
                // Fix: Assign to window so it can be used by other functions
                window.sortedDevotionals = devotionalsData; 

                renderDailyDevotional(categorized.devotionals);
                
                // Initialize School Menu
                renderSchoolMenu();
                
                renderSection(categorized.games, 'grid-games', 'section-games');
                // renderSection([], 'grid-prayers', 'section-prayers'); // Don't overwrite chaplain
            } catch(e) { console.error(e); }
        }

        /* --- School / Quiz Logic --- */
        function renderSchoolMenu() {
            const container = document.querySelector('#school-menu .grid');
            if(!container) return;
            
            let html = '';
            QUIZ_CONFIG.forEach(item => {
                html += `
                    <div onclick="initQuiz('${item.id}')" class="clean-card cursor-pointer group hover:bg-white/80">
                        <div class="flex items-center gap-4 mb-3">
                            <div class="p-3 rounded-full bg-[#F1F3F2] group-hover:bg-[#6B8E23] group-hover:text-white transition-colors text-[#6B8E23]">
                                <i data-lucide="${item.icon}" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-[#3E3B39] text-lg">${item.title}</h3>
                                <p class="text-xs text-[#8D7B68] uppercase tracking-wider">${item.subtitle}</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500">${item.desc}</p>
                    </div>
                `;
            });
            container.innerHTML = html;
            if(window.lucide) lucide.createIcons();
        }

        // Helper: Randomize Array (Fisher-Yates Shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        async function initQuiz(quizId) {
            const config = QUIZ_CONFIG.find(c => c.id === quizId);
            if(!config) return;

            // Show loading state
            document.getElementById('school-menu').classList.add('hidden');
            const quizArea = document.getElementById('school-quiz-area');
            quizArea.classList.remove('hidden');
            quizArea.innerHTML = `<div class="flex flex-col items-center py-20"><i data-lucide="loader-2" class="w-8 h-8 animate-spin text-[#6B8E23] mb-4"></i><p class="text-[#8D7B68]">æ­£åœ¨æº–å‚™è©¦å·...</p></div>`;
            if(window.lucide) lucide.createIcons();

            try {
                const res = await fetch(config.url);
                const rawData = await res.json();
                
                // Shuffle the questions here
                currentQuizData = shuffleArray([...rawData]);
                
                currentQuizConfig = config;
                currentQuestionIndex = 0;
                quizScore = 0;
                userExamAnswers = [];

                if(config.type === 'exam') {
                    startExam();
                } else if (config.type === 'practice') {
                    renderPracticeQuestion();
                } else if (config.type === 'trivia') {
                    renderTriviaCard();
                }

            } catch(e) {
                console.error(e);
                quizArea.innerHTML = `
                    <div class="text-center py-10">
                        <p class="text-red-500 mb-4">é¡Œç›®è¼‰å…¥å¤±æ•—</p>
                        <button onclick="exitQuiz()" class="nature-btn">è¿”å›é¸å–®</button>
                    </div>
                `;
            }
        }

        function exitQuiz() {
            if(quizTimer) clearInterval(quizTimer);
            const quizArea = document.getElementById('school-quiz-area');
            const menuArea = document.getElementById('school-menu');
            if(quizArea) quizArea.classList.add('hidden');
            if(menuArea) menuArea.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        /* --- Exam Mode (Timed) --- */
        function startExam() {
            quizTimeLeft = 180; // 3 minutes
            renderExamUI();
            
            quizTimer = setInterval(() => {
                quizTimeLeft--;
                updateTimerDisplay();
                if(quizTimeLeft <= 0) {
                    finishExam();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const el = document.getElementById('exam-timer');
            const bar = document.getElementById('exam-progress');
            if(el) {
                const m = Math.floor(quizTimeLeft / 60);
                const s = quizTimeLeft % 60;
                el.innerText = `${m}:${s.toString().padStart(2, '0')}`;
                if(quizTimeLeft < 30) el.classList.add('text-red-500');
            }
            if(bar) {
                const pct = (quizTimeLeft / 180) * 100;
                bar.style.width = `${pct}%`;
            }
        }

        function renderExamUI() {
            const quizArea = document.getElementById('school-quiz-area');
            const question = currentQuizData[currentQuestionIndex];
            const total = currentQuizData.length;
            // ç”¢ç”Ÿå”¯ä¸€çš„ ID å‰ç¶´ï¼Œé¿å…ç€è¦½å™¨èª¤åˆ¤ç‹€æ…‹
            const uniquePrefix = `exam-q${currentQuestionIndex}-opt`;

            quizArea.innerHTML = `
                <div class="max-w-2xl mx-auto">
                    <!-- Header -->
                    <div class="flex justify-between items-center mb-6 bg-white/50 p-4 rounded-xl border border-white">
                        <div class="flex items-center gap-2 text-[#3E3B39]">
                            <i data-lucide="file-text" class="w-5 h-5"></i>
                            <span class="font-bold">ç¬¬ ${currentQuestionIndex + 1}/${total} é¡Œ</span>
                        </div>
                        <div class="flex items-center gap-2 font-mono text-xl font-bold text-[#6B8E23]" id="exam-timer">
                            3:00
                        </div>
                    </div>
                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-8 overflow-hidden">
                        <div id="exam-progress" class="bg-[#6B8E23] h-2 rounded-full quiz-progress-bar" style="width: 100%"></div>
                    </div>

                    <!-- Question Card -->
                    <div class="stationery-card animate-fadeIn">
                        <h3 class="text-xl font-bold text-[#3E3B39] mb-6 leading-relaxed">${question['é¡Œç›®']}</h3>
                        <div class="space-y-3">
                            ${generateOptionsHtml(question, 'handleExamAnswer', uniquePrefix)}
                        </div>
                    </div>
                    
                    <div class="text-center mt-8">
                        <button onclick="finishExam()" class="text-sm text-gray-400 hover:text-red-500">ææ—©äº¤å·</button>
                    </div>
                </div>
            `;
            if(window.lucide) lucide.createIcons();
        }

        function handleExamAnswer(selectedOption) {
            // Store user choice
            userExamAnswers[currentQuestionIndex] = selectedOption;
            
            // Move to next
            if (currentQuestionIndex < currentQuizData.length - 1) {
                currentQuestionIndex++;
                renderExamUI();
                updateTimerDisplay(); // Refresh timer text immediately
            } else {
                finishExam();
            }
        }

        function finishExam() {
            if(quizTimer) clearInterval(quizTimer);
            
            // Calculate Score
            let correctCount = 0;
            let resultListHtml = '';

            currentQuizData.forEach((q, idx) => {
                const userAns = userExamAnswers[idx];
                const correctAnsFull = q['æ­£ç¢ºç­”æ¡ˆ']; // e.g. "B(xxx)"
                const correctAnsLetter = correctAnsFull ? correctAnsFull.charAt(0).toUpperCase() : '';
                
                const isCorrect = userAns === correctAnsLetter;
                if(isCorrect) correctCount++;

                // ä¿®æ”¹ï¼šåªé¡¯ç¤ºæœ‰å›ç­”çš„é¡Œç›®
                if (userAns) {
                    const statusIcon = isCorrect ? '<i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>' : '<i data-lucide="x-circle" class="w-5 h-5 text-red-500"></i>';
                    const userAnsText = `é¸é …${userAns}`;
                    
                    resultListHtml += `
                        <div class="bg-white/60 p-4 rounded-lg border ${isCorrect ? 'border-green-200' : 'border-red-200'} mb-3 text-left">
                            <div class="flex gap-3 mb-2">
                                <div class="mt-1">${statusIcon}</div>
                                <div>
                                    <p class="font-bold text-[#3E3B39] text-sm mb-1">ç¬¬ ${idx+1} é¡Œï¼š${q['é¡Œç›®']}</p>
                                    <div class="text-xs text-gray-500 flex flex-wrap gap-x-4 gap-y-1">
                                        <span class="${isCorrect ? 'text-green-600' : 'text-red-500'}">ä½ çš„ç­”æ¡ˆï¼š${userAnsText}</span>
                                        <span class="text-green-600 font-bold">æ­£ç¢ºç­”æ¡ˆï¼š${correctAnsFull}</span>
                                    </div>
                                    ${q['å‚™è¨»'] ? `<div class="mt-2 text-xs text-[#8D7B68] bg-[#F1F3F2] p-2 rounded"><span class="font-bold">ğŸ’¡ å‚™è¨»ï¼š</span>${q['å‚™è¨»']}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            // å¦‚æœä¸€é¡Œéƒ½æ²’ç­”
            if (resultListHtml === '') {
                resultListHtml = '<div class="text-center text-gray-500 py-8">æœ¬å·æœªä½œç­”ä»»ä½•é¡Œç›®</div>';
            }

            const score = Math.round((correctCount / currentQuizData.length) * 100);
            
            const quizArea = document.getElementById('school-quiz-area');
            quizArea.innerHTML = `
                <div class="max-w-2xl mx-auto text-center">
                    <div class="mb-8">
                        <div class="inline-block p-4 rounded-full bg-white shadow-lg mb-4">
                            <span class="text-4xl font-bold ${score >= 60 ? 'text-[#6B8E23]' : 'text-[#D85C42]'}">${score}åˆ†</span>
                        </div>
                        <h2 class="text-2xl font-bold text-[#3E3B39]">æ¸¬é©—çµæŸï¼</h2>
                        <p class="text-gray-500">ç­”å° ${correctCount} / ${currentQuizData.length} é¡Œ</p>
                    </div>
                    
                    <div class="mb-8 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                        ${resultListHtml}
                    </div>

                    <div class="flex justify-center gap-4">
                        <button onclick="exitQuiz()" class="nature-btn bg-white">è¿”å›é¸å–®</button>
                        <button onclick="initQuiz('${currentQuizConfig.id}')" class="nature-btn">å†æ¸¬ä¸€æ¬¡</button>
                    </div>
                </div>
            `;
            if(window.lucide) lucide.createIcons();
        }

        /* --- Practice Mode (Instant Feedback) --- */
        function renderPracticeQuestion() {
            const quizArea = document.getElementById('school-quiz-area');
            const question = currentQuizData[currentQuestionIndex];
            const total = currentQuizData.length;

            quizArea.innerHTML = `
                <div class="max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="exitQuiz()" class="text-sm text-[#8D7B68] hover:text-[#3E3B39] flex items-center gap-1">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i> é€€å‡º
                        </button>
                        <span class="font-bold text-[#6B8E23]">Practice Mode</span>
                        <span class="text-sm text-gray-500">${currentQuestionIndex + 1} / ${total}</span>
                    </div>

                    <div class="stationery-card relative overflow-hidden min-h-[400px] flex flex-col justify-center">
                        <h3 class="text-xl font-bold text-[#3E3B39] mb-8 leading-relaxed text-center">${question['é¡Œç›®']}</h3>
                        <div id="practice-options" class="space-y-3">
                            ${generateOptionsHtml(question, 'handlePracticeAnswer')}
                        </div>
                        
                        <!-- Feedback Area (Hidden initially) -->
                        <div id="practice-feedback" class="hidden mt-6 pt-6 border-t border-gray-200 animate-fadeIn">
                            <div id="feedback-content" class="mb-4"></div>
                            <button onclick="nextPracticeQuestion()" class="nature-btn w-full justify-center">ä¸‹ä¸€é¡Œ <i data-lucide="arrow-right" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            `;
            if(window.lucide) lucide.createIcons();
        }

        function handlePracticeAnswer(selectedOption) {
            // Disable all buttons
            const buttons = document.querySelectorAll('#practice-options button');
            buttons.forEach(btn => btn.disabled = true);

            const question = currentQuizData[currentQuestionIndex];
            const correctAnsFull = question['æ­£ç¢ºç­”æ¡ˆ'];
            const correctAnsLetter = correctAnsFull ? correctAnsFull.charAt(0).toUpperCase() : '';
            const isCorrect = selectedOption === correctAnsLetter;

            // Highlight
            const selectedBtn = document.getElementById(`opt-${selectedOption}`);
            if(selectedBtn) {
                selectedBtn.classList.add(isCorrect ? 'correct' : 'wrong');
                // Force remove hover effect styles manually if needed, or rely on :disabled css
            }
            
            // If wrong, highlight correct one too
            if(!isCorrect) {
                const correctBtn = document.getElementById(`opt-${correctAnsLetter}`);
                if(correctBtn) correctBtn.classList.add('correct');
            }

            // Show Feedback
            const feedbackEl = document.getElementById('practice-feedback');
            const contentEl = document.getElementById('feedback-content');
            
            feedbackEl.classList.remove('hidden');
            contentEl.innerHTML = `
                <div class="flex items-start gap-3 ${isCorrect ? 'text-green-700' : 'text-red-600'}">
                    <i data-lucide="${isCorrect ? 'check-circle' : 'alert-circle'}" class="w-6 h-6 flex-shrink-0 mt-0.5"></i>
                    <div>
                        <p class="font-bold text-lg mb-1">${isCorrect ? 'ç­”å°äº†ï¼' : 'ç­”éŒ¯äº†'}</p>
                        <p class="text-sm text-gray-600"><span class="font-bold">æ­£ç¢ºç­”æ¡ˆï¼š</span>${correctAnsFull}</p>
                        ${question['å‚™è¨»'] ? `<p class="text-sm text-[#8D7B68] mt-2 bg-[#F1F3F2] p-2 rounded"><span class="font-bold">å‚™è¨»ï¼š</span>${question['å‚™è¨»']}</p>` : ''}
                    </div>
                </div>
            `;
            if(window.lucide) lucide.createIcons();
        }

        function nextPracticeQuestion() {
            if (currentQuestionIndex < currentQuizData.length - 1) {
                currentQuestionIndex++;
                renderPracticeQuestion();
            } else {
                // End of practice
                const quizArea = document.getElementById('school-quiz-area');
                quizArea.innerHTML = `
                    <div class="text-center py-20 animate-fadeIn">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600">
                            <i data-lucide="trophy" class="w-10 h-10"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-[#3E3B39] mb-2">ç·´ç¿’å®Œæˆï¼</h2>
                        <p class="text-gray-500 mb-8">ä½ å·²ç¶“å®Œæˆäº†æ‰€æœ‰é¡Œç›®ã€‚</p>
                        <button onclick="exitQuiz()" class="nature-btn">è¿”å›é¸å–®</button>
                    </div>
                `;
                if(window.lucide) lucide.createIcons();
            }
        }

        /* --- Trivia Mode (Flip Card) --- */
        function renderTriviaCard() {
            const quizArea = document.getElementById('school-quiz-area');
            const question = currentQuizData[currentQuestionIndex];
            const total = currentQuizData.length;

            quizArea.innerHTML = `
                <div class="max-w-md mx-auto h-full flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="exitQuiz()" class="text-sm text-[#8D7B68] hover:text-[#3E3B39]">é€€å‡º</button>
                        <span class="font-serif italic text-xl text-[#6B8E23]">Trivia</span>
                        <span class="text-sm text-gray-500">${currentQuestionIndex + 1} / ${total}</span>
                    </div>

                    <div class="flip-card mb-8" onclick="this.classList.toggle('flipped')">
                        <div class="flip-card-inner">
                            <!-- Front -->
                            <div class="flip-card-front">
                                <span class="absolute top-4 left-4 text-xs text-gray-400 tracking-widest">QUESTION</span>
                                <h3 class="text-xl font-bold mb-6 leading-relaxed">${question['é¡Œç›®']}</h3>
                                <div class="w-full text-left space-y-2 text-sm text-gray-600 opacity-80">
                                    <div class="p-2 border rounded">A. ${question['é¸é …A']}</div>
                                    <div class="p-2 border rounded">B. ${question['é¸é …B']}</div>
                                    <div class="p-2 border rounded">C. ${question['é¸é …C']}</div>
                                    <div class="p-2 border rounded">D. ${question['é¸é …D']}</div>
                                </div>
                                <div class="absolute bottom-4 text-xs text-[#6B8E23] animate-bounce">é»æ“Šç¿»ç‰ŒæŸ¥çœ‹ç­”æ¡ˆ</div>
                            </div>
                            <!-- Back -->
                            <div class="flip-card-back">
                                <span class="absolute top-4 left-4 text-xs text-white/60 tracking-widest">ANSWER</span>
                                <div class="text-center">
                                    <p class="text-6xl mb-4 font-serif text-white/20">A</p> <!-- Decorative -->
                                    <h3 class="text-2xl font-bold mb-2">${question['æ­£ç¢ºç­”æ¡ˆ']}</h3>
                                    <div class="w-12 h-1 bg-white/50 mx-auto my-4 rounded"></div>
                                    ${question['å‚™è¨»'] ? `<p class="text-white/90 text-sm leading-relaxed">${question['å‚™è¨»']}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between gap-4 mt-auto">
                        <button onclick="prevTrivia()" class="nature-btn flex-1 justify-center" ${currentQuestionIndex === 0 ? 'disabled style="opacity:0.5"' : ''}>
                            <i data-lucide="arrow-left" class="w-4 h-4"></i> ä¸Šä¸€å¼µ
                        </button>
                        <button onclick="nextTrivia()" class="nature-btn flex-1 justify-center" ${currentQuestionIndex === total - 1 ? 'disabled style="opacity:0.5"' : ''}>
                            ä¸‹ä¸€å¼µ <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;
            if(window.lucide) lucide.createIcons();
        }

        function nextTrivia() {
            if(currentQuestionIndex < currentQuizData.length - 1) {
                currentQuestionIndex++;
                renderTriviaCard();
            }
        }
        function prevTrivia() {
            if(currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderTriviaCard();
            }
        }

        /* --- Helpers --- */
        function generateOptionsHtml(q, clickHandlerName, idPrefix = 'opt') {
            const opts = ['A', 'B', 'C', 'D'];
            let html = '';
            opts.forEach(opt => {
                const text = q[`é¸é …${opt}`];
                if(text) {
                    // ä½¿ç”¨å‚³å…¥çš„å‰ç¶´ä¾†ç”¢ç”Ÿ IDï¼Œç¢ºä¿å”¯ä¸€æ€§
                    html += `
                        <button id="${idPrefix}-${opt}" onclick="${clickHandlerName}('${opt}')" class="quiz-option w-full text-left p-4 rounded-xl border border-gray-200 bg-white/60 hover:bg-white transition-all flex items-center gap-3 group">
                            <span class="w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center text-sm text-gray-500 font-bold group-hover:border-[#6B8E23] group-hover:text-[#6B8E23] transition-colors bg-white">${opt}</span>
                            <span class="flex-1 text-[#3E3B39] font-medium">${text}</span>
                        </button>
                    `;
                }
            });
            return html;
        }

        function getTodayString() {
            const d = new Date();
            return `${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
        }

        function extractMonthDay(dateStr) {
            if (!dateStr) return null;
            if (dateStr.includes('T') && dateStr.includes('Z')) {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    const taipeiTime = new Date(date.getTime() + 8 * 60 * 60 * 1000);
                    const mm = (taipeiTime.getUTCMonth() + 1).toString().padStart(2, '0');
                    const dd = taipeiTime.getUTCDate().toString().padStart(2, '0');
                    return `${mm}-${dd}`;
                }
            }
            let s = dateStr.replace(/[^\d\-\/\.]/g,'');
            let p = s.split(/[-/.]/).filter(x=>x);
            if(p.length>=2) return `${parseInt(p[p.length-2]).toString().padStart(2,'0')}-${parseInt(p[p.length-1]).toString().padStart(2,'0')}`;
            return null;
        }

        function categorizeData(data) {
            const c = { verses:[], devotionals:[], school:[], games:[] };
            data.forEach(i => {
                let t = ''; 
                for(let k in i) if(/title|name/i.test(k)) t = i[k].toLowerCase();
                if(t.includes('å­¸éœ¸')||t.includes('æ¸¬é©—')||t.includes('å†·çŸ¥è­˜')) c.school.push(i);
                else if(t.includes('éŠæˆ²')||t.includes('ç ´å†°')) c.games.push(i);
                else c.devotionals.push(i); 
            });
            return c;
        }

        function renderDailyDevotional(items) {
            const container = document.getElementById('daily-content');
            const today = getTodayString();
            
            // 1. Get Today's Reading Plan
            const dObj = new Date();
            const m = dObj.getMonth() + 1;
            const d = dObj.getDate();
            const plan = bibleReadingPlan[`${m}-${d}`];

            let html = '';

            // Render Reading Plan "ä»Šæ—¥èª²è¡¨"
            if (plan) {
                html += `
                    <div class="mb-10 text-center w-full">
                        <div class="inline-block px-6 py-2 border-b-2 border-[#6B8E23] mb-6">
                            <h2 class="text-2xl font-serif text-[#3E3B39] tracking-widest">ä»Šæ—¥èª²è¡¨</h2>
                            <p class="text-xs text-[#8D7B68] uppercase mt-1">Today's Schedule (${today})</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-3xl mx-auto px-2">
                            <button onclick="openScripture('${plan.ot.replace(/'/g, "\\'")}')" class="reading-plan-btn">
                                <span class="label">OLD TESTAMENT</span>
                                <span class="content">${plan.ot}</span>
                                <i data-lucide="book-open"></i>
                            </button>
                            <button onclick="openScripture('${plan.nt.replace(/'/g, "\\'")}')" class="reading-plan-btn">
                                <span class="label">NEW TESTAMENT</span>
                                <span class="content">${plan.nt}</span>
                                <i data-lucide="book-open"></i>
                            </button>
                            <button onclick="openScripture('${plan.ps.replace(/'/g, "\\'")}')" class="reading-plan-btn">
                                <span class="label">PSALMS</span>
                                <span class="content">${plan.ps}</span>
                                <i data-lucide="book-open"></i>
                            </button>
                            <button onclick="openScripture('${plan.pr.replace(/'/g, "\\'")}')" class="reading-plan-btn">
                                <span class="label">PROVERBS</span>
                                <span class="content">${plan.pr}</span>
                                <i data-lucide="book-open"></i>
                            </button>
                        </div>
                    </div>
                    <div class="divider-water opacity-50 mb-10 w-full"></div>
                `;
            } else {
                 // Fallback message if no plan found (e.g. not Jan)
                 html += `<div class="mb-6 text-center text-sm text-gray-400">ä»Šæ—¥(${today})ç„¡æŒ‡å®šè®€ç¶“é€²åº¦</div>`;
            }

            // 2. Render Existing Devotionals
            const todayItems = items.filter(i => {
                let k = Object.keys(i).find(key => /date|time|æ—¥æœŸ/i.test(key));
                return k && extractMonthDay(i[k]) === today;
            });
            
            if(todayItems.length > 0) {
                todayItems.forEach(i => html += generateSingleDevotionalHtml(i));
            } else if (!plan) {
                html += `<div class="py-10"><p class="text-[#8D7B68]">ä»Šæ—¥æš«ç„¡èª²ç¨‹ (${today})</p><button onclick="showFullSchedule()" class="nature-btn mt-4">æŸ¥çœ‹èª²è¡¨</button></div>`;
            }

            container.innerHTML = html;
            if(window.lucide) lucide.createIcons();
        }

        function generateSingleDevotionalHtml(item) {
             let contentHtml = `<div class="text-left w-full space-y-6 text-[#585858] font-light text-lg">`;
             let buttonsArray = []; 
             let skipKeys = []; 

             const keys = Object.keys(item);
             let titleKey = keys.find(k => /title|name|æ¨™é¡Œ|åç¨±/i.test(k)) || 'No Title';
             const title = item[titleKey];
             contentHtml += `<h2 class="text-3xl font-serif text-[#3E3B39] mb-4 text-center">${title}</h2>`;
             
             // 1. Intelligent Merging
             const songNameKey = keys.find(k => /^(song|hymn|worship|praise|è©©æ­Œ|æ•¬æ‹œ|è®šç¾|é ˜è©©|ç¨å”±)$/i.test(k) && typeof item[k] === 'string' && !/(https?:\/\/|www\.)/.test(item[k]));
             const linkKey = keys.find(k => /^(link|url|video|youtube|é€£çµ|ç¶²å€)$/i.test(k) && typeof item[k] === 'string' && /(https?:\/\/|www\.)/.test(item[k]));

             if (songNameKey && linkKey) {
                 const urlMatch = item[linkKey].match(/(https?:\/\/[^\s]+)|(www\.[^\s]+)/);
                 if (urlMatch) {
                     let url = urlMatch[0];
                     if (url.startsWith('www.')) url = 'https://' + url;
                     url = url.replace(/[\)\]\}\>]+$/, '');
                     
                     buttonsArray.push({ type: 'link', url: url, text: item[songNameKey] });
                     skipKeys.push(songNameKey);
                     skipKeys.push(linkKey);
                 }
             }

             // 2. Process remaining keys
             keys.forEach(k => {
                 if (k === titleKey || /date|time/.test(k)) return;
                 if (skipKeys.includes(k)) return; 

                 const val = item[k];
                 
                 // Identify scripture keys - ADD 'ref' here
                 const isBibleKey = /scripture|reading|bible|chapter|ref|ç¶“æ–‡|è®€ç¶“/i.test(k);
                 
                 // MODIFY: Skip scripture keys entirely as requested
                 if (isBibleKey) return;

                 const hasUrl = typeof val === 'string' && /(https?:\/\/[^\s]+)|(www\.[^\s]+)/.test(val);

                 if (hasUrl) {
                     const urlMatch = val.match(/(https?:\/\/[^\s]+)|(www\.[^\s]+)/);
                     if (urlMatch) {
                         let url = urlMatch[0];
                         if (url.startsWith('www.')) url = 'https://' + url;
                         url = url.replace(/[\)\]\}\>]+$/, '');

                         let text = val.replace(urlMatch[0], '').trim();
                         text = text.replace(/^[:ï¼š\(\[\{\s]+|[\)\]\}\s]+$/g, '').trim();
                         
                         if (!text) {
                             if (/^(link|url)$/i.test(k)) {
                                 text = item[songNameKey] || "è©©æ­Œ"; 
                             } else {
                                 text = k; 
                             }
                         }
                         
                         buttonsArray.push({ type: 'link', url: url, text: text });
                     } else {
                         contentHtml += `<p class="whitespace-pre-wrap">${val}</p>`;
                     }
                 }
                 else {
                     contentHtml += `<p class="whitespace-pre-wrap">${val}</p>`;
                 }
             });
             
             contentHtml += `</div>`; 
             
             if (buttonsArray.length > 0) {
                 contentHtml += `<div class="mt-10 pt-6 border-t border-[rgba(107,142,35,0.2)] w-full flex flex-col gap-4 items-center">`;
                 
                 buttonsArray.forEach(btn => {
                     if(btn.type === 'link') {
                         contentHtml += `
                            <a href="${btn.url}" target="_blank" class="w-full max-w-md block group">
                                <div class="bg-[#6B8E23] hover:bg-[#556B2F] text-white rounded-2xl py-3 px-4 text-center shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2 transform group-hover:-translate-y-0.5 overflow-hidden">
                                    <span class="text-sm font-light opacity-90 mr-1 whitespace-nowrap flex-shrink-0">ä»Šæ—¥é»æ’­</span>
                                    <span class="text-lg font-medium tracking-wide truncate border-b border-white/30 pb-0.5 max-w-[160px] sm:max-w-xs">${btn.text}</span>
                                    <i data-lucide="headphones" class="w-5 h-5 flex-shrink-0 ml-1"></i>
                                </div>
                            </a>
                         `;
                     } else if (btn.type === 'bible') {
                         contentHtml += `
                            <button onclick="openScripture('${btn.safeVal}')" class="w-full max-w-md nature-btn scripture-btn py-3 rounded-2xl flex items-center justify-center gap-2 text-base">
                                <i data-lucide="book-open" class="w-5 h-5"></i>
                                <span>é–±è®€ç¶“æ–‡: ${btn.val}</span>
                            </button>
                         `;
                     }
                 });
                 
                 contentHtml += `</div>`;
             }
             
             return contentHtml;
        }
        
        function renderSection(items, cId, sId) {
            const c = document.getElementById(cId);
            if(items.length===0) { c.innerHTML = `<div class="col-span-full text-center py-10 opacity-50">æš«ç„¡è³‡æ–™</div>`; return; }
            let h = '';
            items.forEach(i => {
                let title = Object.values(i)[0]; 
                h += `<div class="clean-card"><h3 class="font-bold text-[#3E3B39] mb-2">${title}</h3></div>`; 
            });
            c.innerHTML = h;
        }
        
        function showFullSchedule() {
             const c = document.getElementById('daily-content');
             const sorted = window.sortedDevotionals || [];
             let h = '<div class="space-y-2 text-left w-full max-w-lg mx-auto">';
             sorted.forEach((i, idx) => {
                 let k = Object.keys(i).find(key => /date|time/.test(key)), d = extractMonthDay(i[k]);
                 let tKey = Object.keys(i).find(key => /title|name/.test(key)), t = i[tKey] || 'Untitled';
                 h += `<div onclick="renderSpecificItem(${idx})" class="p-3 border rounded cursor-pointer hover:bg-[rgba(255,255,255,0.4)] flex justify-between bg-[rgba(255,255,255,0.2)]"><span>${d}</span> <span>${t}</span></div>`;
             });
             h += '</div><div class="text-center mt-4"><button onclick="resetDailyView()" class="nature-btn">è¿”å›ä»Šæ—¥</button></div>';
             c.innerHTML = h;
             if(window.lucide) lucide.createIcons();
        }
        
        function renderSpecificItem(idx) {
             const item = (window.sortedDevotionals || [])[idx];
             const container = document.getElementById('daily-content');
             container.innerHTML = generateSingleDevotionalHtml(item) + '<div class="text-center mt-6"><button onclick="showFullSchedule()" class="nature-btn">è¿”å›åˆ—è¡¨</button></div>';
             if(window.lucide) lucide.createIcons();
        }

        function resetDailyView() { renderDailyDevotional(devotionalsData); }

        init();
    </script>
</body>
</html>
